<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Chanclazo Online - Edición Montañas</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <style>
    html, body { margin: 0; padding: 0; overflow: hidden; height: 100%; font-family: sans-serif; background: #87CEEB; }
    canvas { display: block; }
    
    /* Interfaz de Red */
    #overlay-red { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; justify-content: center; align-items: center; z-index: 2000; }
    .panel { background: white; padding: 30px; border-radius: 20px; text-align: center; border: 4px solid #4682B4; width: 320px; }
    button { padding: 12px 25px; margin: 10px; cursor: pointer; border: none; border-radius: 8px; background: #4682B4; color: white; font-weight: bold; }
    input { padding: 10px; width: 80%; margin-bottom: 10px; text-align: center; border: 2px solid #ddd; border-radius: 5px; }
    
    #info-partida { position: absolute; top: 20px; left: 20px; background: rgba(255,255,255,0.8); padding: 15px; border-radius: 10px; border: 2px solid #4682B4; pointer-events: none; }
    #indicador-turno { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); font-size: 30px; font-weight: bold; color: white; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); }
    .controles { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(255,255,255,0.9); padding: 20px; border-radius: 15px; display: none; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
    .hidden { display: none; }
  </style>
</head>
<body>

  <div id="indicador-turno">CONECTANDO...</div>

  <div id="overlay-red">
    <div class="panel" id="menu-inicial">
      <h2 style="color:#4682B4">CHANCLAZO ONLINE</h2>
      <button onclick="crearPartida()">CREAR SALA</button>
      <button onclick="mostrarUnirse()" style="background:#f5576c">UNIRSE A SALA</button>
      <div id="div-unirse" class="hidden">
        <hr>
        <input type="text" id="input-codigo" placeholder="Código de sala">
        <button onclick="unirsePartida()">ENTRAR</button>
      </div>
      <div id="div-espera" class="hidden">
        <p>Código de tu sala:</p>
        <h1 id="codigo-display" style="color:#f5576c; font-size: 45px; margin: 10px;">----</h1>
        <p>Esperando al otro jugador...</p>
      </div>
    </div>
  </div>

  <div id="info-partida">
    <div id="v-j1">Jugador 1: 100%</div>
    <div id="v-j2">Jugador 2: 100%</div>
  </div>

  <div class="controles">
    Ángulo: <input type="range" id="rangeAngulo" min="0" max="180" value="45"> <span id="txtAngulo">45</span>° | 
    Potencia: <input type="range" id="rangePotencia" min="0" max="140" value="70"> <span id="txtPotencia">70</span>
    <button id="btnLanzar">¡LANZAR!</button>
  </div>

  <canvas id="canvasJuego"></canvas>

  <script>
    // --- CONFIGURACIÓN FIREBASE ---
    const firebaseConfig = {
        apiKey: "AIzaSyJCSHKPGMpezHW3o5AxR5Wzupuz3aI",
        authDomain: "carrera-constitucional.firebaseapp.com",
        databaseURL: "https://carrera-constitucional-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "carrera-constitucional",
        storageBucket: "carrera-constitucional.firebasestorage.app",
        messagingSenderId: "627786732121",
        appId: "1:627786732121:web:9f1cc7c0b94887a9501b48"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // --- VARIABLES DEL JUEGO ---
    const canvas = document.getElementById('canvasJuego');
    const ctx = canvas.getContext('2d');
    let gameId, miRol, turnoActual;
    let jugadores = [], proyectiles = [], montañas = [], nubes = [];
    let gravedad = 0.25;
    let juegoActivo = false;

    // --- RED Y LOBBY ---
    function crearPartida() {
      gameId = Math.floor(1000 + Math.random() * 9000).toString();
      miRol = 1;
      document.getElementById('menu-inicial').querySelector('button').classList.add('hidden');
      document.getElementById('div-espera').classList.remove('hidden');
      document.getElementById('codigo-display').textContent = gameId;
      db.ref('games/' + gameId).set({ estado: 'esperando', turno: 1 });
      escucharFirebase();
    }

    function mostrarUnirse() { document.getElementById('div-unirse').classList.toggle('hidden'); }

    function unirsePartida() {
      gameId = document.getElementById('input-codigo').value;
      miRol = 2;
      db.ref('games/' + gameId).once('value', s => {
        if(s.exists() && s.val().estado === 'esperando') {
          db.ref('games/' + gameId).update({ estado: 'jugando' });
          iniciarJuego();
        } else alert("Sala no disponible");
      });
      escucharFirebase();
    }

    function escucharFirebase() {
      db.ref('games/' + gameId).on('value', s => {
        const d = s.val();
        if(!d) return;
        if(d.estado === 'jugando' && !juegoActivo) iniciarJuego();
        turnoActual = d.turno;
        
        // Sincronizar disparo oponente
        if(d.ultimoDisparo && d.ultimoDisparo.autor !== miRol) {
          const l = d.ultimoDisparo;
          crearProyectil(l.x, l.y, l.vx, l.vy, l.autor);
          db.ref('games/' + gameId + '/ultimoDisparo').set(null); 
        }
        actualizarUI();
      });
    }

    function actualizarUI() {
      const indicador = document.getElementById('indicador-turno');
      const controles = document.querySelector('.controles');
      if(turnoActual === miRol) {
        indicador.textContent = "TU TURNO";
        indicador.style.color = "#2ecc71";
        controles.style.display = 'block';
      } else {
        indicador.textContent = "ESPERANDO AL RIVAL...";
        indicador.style.color = "#e74c3c";
        controles.style.display = 'none';
      }
    }

    // --- MOTOR GRÁFICO ---
    function iniciarJuego() {
      juegoActivo = true;
      document.getElementById('overlay-red').style.display = 'none';
      redimensionar();
      generarMapa();
      bucle();
    }

    function redimensionar() {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
    }

    function generarMapa() {
      // Terreno (Montañas)
      montañas = [];
      let puntos = 10;
      for(let i=0; i<=puntos; i++) {
        montañas.push({
          x: (canvas.width / puntos) * i,
          y: canvas.height - (100 + Math.random() * 200)
        });
      }
      // Jugadores en posiciones fijas para evitar desincronía
      jugadores = [
        { id: 1, x: 150, y: 0, vida: 100, color: '#FF4757' },
        { id: 2, x: canvas.width - 150, y: 0, vida: 100, color: '#1E90FF' }
      ];
      // Ajustar Y al terreno
      jugadores.forEach(j => j.y = obtenerAlturaTerreno(j.x) - 15);
      
      for(let i=0; i<6; i++) nubes.push({ x: Math.random()*canvas.width, y: Math.random()*200, v: 0.3+Math.random() });
    }

    function obtenerAlturaTerreno(x) {
      for(let i=0; i<montañas.length-1; i++) {
        if(x >= montañas[i].x && x <= montañas[i+1].x) {
          let t = (x - montañas[i].x) / (montañas[i+1].x - montañas[i].x);
          return montañas[i].y + t * (montañas[i+1].y - montañas[i].y);
        }
      }
      return canvas.height;
    }

    document.getElementById('btnLanzar').onclick = () => {
      if(turnoActual !== miRol) return;
      const ang = document.getElementById('rangeAngulo').value;
      const pot = document.getElementById('rangePotencia').value;
      const rad = ang * Math.PI / 180;
      const j = jugadores[miRol-1];
      
      const vx = Math.cos(rad) * (pot/5) * (miRol === 1 ? 1 : -1);
      const vy = -Math.sin(rad) * (pot/5);

      crearProyectil(j.x, j.y, vx, vy, miRol);
      db.ref('games/' + gameId).update({
        turno: miRol === 1 ? 2 : 1,
        ultimoDisparo: { x: j.x, y: j.y, vx, vy, autor: miRol }
      });
    };

    function crearProyectil(x, y, vx, vy, autor) {
      proyectiles.push({ x, y, vx, vy, autor, radio: 8 });
    }

    function bucle() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      dibujarCielo();
      dibujarTerreno();
      
      // Nubes
      ctx.fillStyle = "rgba(255,255,255,0.7)";
      nubes.forEach(n => {
        n.x += n.v; if(n.x > canvas.width) n.x = -50;
        ctx.beginPath(); ctx.arc(n.x, n.y, 25, 0, Math.PI*2); ctx.fill();
      });

      // Jugadores
      jugadores.forEach((j, i) => {
        ctx.fillStyle = j.color;
        ctx.beginPath(); ctx.arc(j.x, j.y, 15, 0, Math.PI*2); ctx.fill();
        document.getElementById(`v-j${i+1}`).textContent = `Jugador ${i+1}: ${j.vida}%`;
      });

      // Física de Proyectiles
      for(let i=proyectiles.length-1; i>=0; i--) {
        let p = proyectiles[i];
        p.x += p.vx; p.vy += gravedad; p.y += p.vy;
        
        ctx.fillStyle = "#333";
        ctx.beginPath(); ctx.arc(p.x, p.y, p.radio, 0, Math.PI*2); ctx.fill();

        // Colisión Suelo
        if(p.y > obtenerAlturaTerreno(p.x)) proyectiles.splice(i, 1);

        // Colisión Oponente
        jugadores.forEach(j => {
          if(p.autor !== j.id) {
            let d = Math.hypot(p.x - j.x, p.y - j.y);
            if(d < 20) {
              j.vida -= 20;
              proyectiles.splice(i, 1);
              if(j.vida <= 0) { alert("¡PARTIDA TERMINADA!"); location.reload(); }
            }
          }
        });
      }
      requestAnimationFrame(bucle);
    }

    function dibujarCielo() {
      let g = ctx.createLinearGradient(0,0,0,canvas.height);
      g.addColorStop(0, '#87CEEB'); g.addColorStop(1, '#E0F7FA');
      ctx.fillStyle = g; ctx.fillRect(0,0,canvas.width, canvas.height);
    }

    function dibujarTerreno() {
      ctx.fillStyle = "#2ecc71";
      ctx.beginPath();
      ctx.moveTo(0, canvas.height);
      montañas.forEach(m => ctx.lineTo(m.x, m.y));
      ctx.lineTo(canvas.width, canvas.height);
      ctx.fill();
    }

    // Actualizar labels de los inputs
    document.getElementById('rangeAngulo').oninput = e => document.getElementById('txtAngulo').textContent = e.target.value;
    document.getElementById('rangePotencia').oninput = e => document.getElementById('txtPotencia').textContent = e.target.value;

    window.onresize = redimensionar;
  </script>
</body>
</html>