<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Batalla Constitucional Online - T√≠tulo Preliminar</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow-x: hidden;
        }

        .container {
            max-width: 900px;
            width: 95%;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            padding: 30px;
            text-align: center;
            color: white;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.95;
        }

        .content {
            padding: 40px;
        }

        /* Pantalla de lobby */
        .lobby-screen {
            text-align: center;
        }

        .lobby-screen h2 {
            color: #667eea;
            font-size: 2em;
            margin-bottom: 20px;
        }

        .lobby-screen p {
            color: #666;
            font-size: 1.1em;
            line-height: 1.8;
            margin-bottom: 30px;
        }

        .lobby-options {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-bottom: 30px;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.2em;
            border-radius: 50px;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);
        }

        .input-group {
            margin: 20px 0;
        }

        .input-group input {
            padding: 15px 20px;
            font-size: 1.2em;
            border: 2px solid #ddd;
            border-radius: 10px;
            width: 300px;
            text-align: center;
            text-transform: uppercase;
        }

        .input-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .game-code {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .game-code h3 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .game-code .code {
            font-size: 3em;
            font-weight: bold;
            color: #f5576c;
            letter-spacing: 10px;
            font-family: 'Courier New', monospace;
        }

        .waiting-message {
            color: #666;
            font-size: 1.2em;
            margin: 20px 0;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .players-status {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .player-slot {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            margin: 5px 0;
            background: white;
            border-radius: 5px;
        }

        .player-slot.ready {
            background: #84fab0;
        }

        /* Pantalla de bienvenida */
        .welcome-screen {
            text-align: center;
            display: none;
        }

        .welcome-screen h2 {
            color: #667eea;
            font-size: 2em;
            margin-bottom: 20px;
        }

        .welcome-screen p {
            color: #666;
            font-size: 1.1em;
            line-height: 1.8;
            margin-bottom: 30px;
        }

        /* Pantalla de art√≠culo */
        .article-screen {
            display: none;
        }

        .article-box {
            background: #f8f9fa;
            border-left: 5px solid #667eea;
            padding: 25px;
            margin-bottom: 30px;
            border-radius: 10px;
            line-height: 1.8;
        }

        .article-box h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.5em;
        }

        .article-box p {
            color: #333;
            font-size: 1.05em;
        }

        .timer {
            text-align: center;
            font-size: 1.5em;
            color: #f5576c;
            font-weight: bold;
            margin: 20px 0;
        }

        /* Pantalla de preguntas */
        .quiz-screen {
            display: none;
        }

        .player-info {
            background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 25px;
            text-align: center;
        }

        .player-info h3 {
            color: #333;
            font-size: 1.8em;
            margin-bottom: 10px;
        }

        .fuel-bar {
            background: white;
            height: 30px;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.1);
        }

        .fuel-fill {
            height: 100%;
            background: linear-gradient(90deg, #f093fb 0%, #f5576c 100%);
            transition: width 0.5s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .question-box {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 25px;
        }

        .question-box h4 {
            color: #667eea;
            font-size: 1.3em;
            margin-bottom: 20px;
        }

        .options {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .option {
            background: white;
            border: 2px solid #ddd;
            padding: 15px 20px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1.05em;
        }

        .option:hover {
            border-color: #667eea;
            transform: translateX(5px);
            box-shadow: 0 3px 10px rgba(102, 126, 234, 0.2);
        }

        .option.selected {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .option.correct {
            background: #84fab0;
            border-color: #84fab0;
            animation: pulse-once 0.5s;
        }

        .option.incorrect {
            background: #f5576c;
            color: white;
            border-color: #f5576c;
            animation: shake 0.5s;
        }

        @keyframes pulse-once {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        /* Pantalla de carrera */
        .battle-screen {
            display: none;
        }

        .race-info {
            text-align: center;
            margin-bottom: 20px;
            padding: 15px;
            background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%);
            border-radius: 10px;
        }

        .race-info h3 {
            color: #2d3436;
            font-size: 1.5em;
            margin-bottom: 5px;
        }

        .racetrack {
            background: linear-gradient(to bottom, #87CEEB 0%, #E0F6FF 30%, #90EE90 30%, #7CB342 100%);
            min-height: 400px;
            border-radius: 10px;
            position: relative;
            overflow: hidden;
            margin-bottom: 20px;
            padding: 40px 20px;
        }

        .finish-line {
            position: absolute;
            right: 30px;
            top: 0;
            bottom: 0;
            width: 20px;
            background: repeating-linear-gradient(
                45deg,
                #000,
                #000 10px,
                #fff 10px,
                #fff 20px
            );
            border: 3px solid #333;
        }

        .race-lane {
            position: relative;
            height: 120px;
            margin-bottom: 40px;
            border-bottom: 3px dashed #999;
        }

        .lane-label {
            position: absolute;
            left: 10px;
            top: 10px;
            font-weight: bold;
            font-size: 1.2em;
            padding: 5px 10px;
            border-radius: 5px;
            background: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .horse {
            position: absolute;
            left: 60px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 3em;
            transition: left 1.5s ease-out;
            filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.3));
        }

        .horse.blue {
            color: #4A90E2;
        }

        .horse.red {
            color: #E74C3C;
        }

        .runner {
            display: inline-block;
            transform: scaleX(-1);
            animation: running 0.5s ease-in-out infinite;
        }

        @keyframes running {
            0% { transform: scaleX(-1) translateY(0px) rotate(0deg); }
            25% { transform: scaleX(-1) translateY(-5px) rotate(-3deg); }
            50% { transform: scaleX(-1) translateY(0px) rotate(0deg); }
            75% { transform: scaleX(-1) translateY(-5px) rotate(3deg); }
            100% { transform: scaleX(-1) translateY(0px) rotate(0deg); }
        }

        .horse.moving .runner {
            animation: running-fast 0.3s ease-in-out infinite;
        }

        @keyframes running-fast {
            0% { transform: scaleX(-1) translateY(0px) rotate(0deg) scale(1); }
            25% { transform: scaleX(-1) translateY(-8px) rotate(-5deg) scale(1.05); }
            50% { transform: scaleX(-1) translateY(0px) rotate(0deg) scale(1); }
            75% { transform: scaleX(-1) translateY(-8px) rotate(5deg) scale(1.05); }
            100% { transform: scaleX(-1) translateY(0px) rotate(0deg) scale(1); }
        }

        .distance-marker {
            position: absolute;
            left: 60px;
            bottom: 5px;
            font-size: 0.9em;
            font-weight: bold;
            color: #333;
            background: white;
            padding: 2px 8px;
            border-radius: 5px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }

        .progress-bars {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .progress-container {
            flex: 1;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
        }

        .progress-label {
            font-weight: bold;
            margin-bottom: 8px;
            font-size: 1.1em;
        }

        .progress-label.blue { color: #4A90E2; }
        .progress-label.red { color: #E74C3C; }

        .progress-bar {
            background: #ddd;
            height: 30px;
            border-radius: 15px;
            overflow: hidden;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            transition: width 1.5s ease-out;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 0.9em;
        }

        .progress-fill.blue { background: linear-gradient(90deg, #4A90E2 0%, #5DADE2 100%); }
        .progress-fill.red { background: linear-gradient(90deg, #E74C3C 0%, #EC7063 100%); }

        .winner-screen {
            display: none;
            text-align: center;
        }

        .winner-screen h2 {
            font-size: 3em;
            color: #667eea;
            margin-bottom: 20px;
            animation: bounce 1s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }

        .trophy { font-size: 5em; margin: 20px 0; }
        .hidden { display: none; }
        .error-message { background: #f5576c; color: white; padding: 15px; border-radius: 10px; margin: 20px 0; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>‚öîÔ∏è Batalla Constitucional Online ‚öîÔ∏è</h1>
            <p>T√≠tulo Preliminar de la Constituci√≥n Espa√±ola</p>
        </div>

        <div class="content">
            <div class="lobby-screen" id="lobbyScreen">
                <h2>üåê Modo Multijugador Online</h2>
                <p>Juega con un amigo desde cualquier lugar.<br>Uno crea la sala y el otro se une con el c√≥digo.</p>
                <div class="lobby-options">
                    <button class="btn" onclick="createGame()">Crear Sala</button>
                    <button class="btn btn-secondary" onclick="showJoinGame()">Unirse a Sala</button>
                </div>
                <div id="joinGameDiv" class="hidden">
                    <div class="input-group"><input type="text" id="gameCodeInput" placeholder="C√≥digo" maxlength="4"></div>
                    <button class="btn" onclick="joinGame()">Entrar</button>
                </div>
                <div id="gameCreatedDiv" class="hidden">
                    <div class="game-code">
                        <h3>C√≥digo de tu sala:</h3>
                        <div class="code" id="gameCodeDisplay"></div>
                    </div>
                    <div class="waiting-message">‚è≥ Esperando al Jugador 2...</div>
                    <div class="players-status">
                        <div class="player-slot ready"><span>‚úÖ</span><span>T√∫ (Jugador 1)</span></div>
                        <div class="player-slot" id="player2Status"><span>‚è≥</span><span>Jugador 2</span></div>
                    </div>
                </div>
                <div id="errorDiv" class="hidden"><div class="error-message" id="errorMessage"></div></div>
            </div>

            <div class="welcome-screen" id="welcomeScreen">
                <h2>üéÆ ¬°Bienvenidos a la Carrera!</h2>
                <p>9 etapas, 9 art√≠culos. Cada acierto te da 20 metros.<br>¬°El primero en llegar a los 900m gana!</p>
                <button class="btn" id="startBtn" onclick="startGame()">¬°Comenzar Batalla!</button>
                <p id="waitingForStart" class="hidden" style="color:#f5576c">Esperando a que el Creador inicie...</p>
            </div>

            <div class="article-screen" id="articleScreen">
                <div class="article-box" id="articleBox"></div>
                <div class="timer" id="articleTimer">Tiempo para leer: <span id="timeLeft">30</span>s</div>
            </div>

            <div class="quiz-screen" id="quizScreen">
                <div class="player-info">
                    <h3 id="currentPlayerName">Jugador</h3>
                    <div class="fuel-bar"><div class="fuel-fill" id="fuelFill" style="width: 0%"><span id="fuelText">0 L</span></div></div>
                </div>
                <div class="question-box">
                    <h4 id="questionText">Cargando pregunta...</h4>
                    <div class="options" id="optionsContainer"></div>
                </div>
                <div style="text-align: center;"><button class="btn" id="nextBtn" style="display: none;" onclick="nextQuestion()">Siguiente</button></div>
            </div>

            <div class="waiting-screen" id="waitingScreen" style="display: none; text-align: center;">
                <h2>‚úÖ ¬°Has terminado la etapa!</h2>
                <div class="waiting-message">‚è≥ Esperando a que el otro jugador termine...</div>
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin: 20px 0;">
                    <p>Tu avance en esta etapa:</p>
                    <div style="font-size: 2.5em; color: #f5576c; font-weight: bold;"><span id="myScore">0</span>m</div>
                </div>
            </div>

            <div class="battle-screen" id="battleScreen">
                <div class="race-info"><h3 id="raceTitle">Etapa 1 de 9</h3></div>
                <div class="progress-bars">
                    <div class="progress-container">
                        <div class="progress-label blue">üèÉ J1</div>
                        <div class="progress-bar"><div class="progress-fill blue" id="progress1" style="width: 0%"><span id="progressText1">0m</span></div></div>
                    </div>
                    <div class="progress-container">
                        <div class="progress-label red">üèÉ‚Äç‚ôÄÔ∏è J2</div>
                        <div class="progress-bar"><div class="progress-fill red" id="progress2" style="width: 0%"><span id="progressText2">0m</span></div></div>
                    </div>
                </div>
                <div class="racetrack" id="racetrack">
                    <div class="finish-line"></div>
                    <div class="race-lane"><div class="horse blue" id="horse1"><span class="runner">üèÉ</span></div><div class="distance-marker" id="distance1">0m</div></div>
                    <div class="race-lane"><div class="horse red" id="horse2"><span class="runner">üèÉ‚Äç‚ôÄÔ∏è</span></div><div class="distance-marker" id="distance2">0m</div></div>
                </div>
                <div style="text-align:center"><button class="btn" id="continueBtn" onclick="continueRace()">Siguiente Etapa</button></div>
            </div>

            <div class="winner-screen" id="winnerScreen">
                <div class="trophy">üèÜ</div>
                <h2 id="winnerText">¬°Ganador!</h2>
                <button class="btn" onclick="location.reload()">Jugar de Nuevo</button>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyJCSHKPGMpezHW3o5AxR5Wzupuz3aI",
            authDomain: "carrera-constitucional.firebaseapp.com",
            databaseURL: "https://carrera-constitucional-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "carrera-constitucional",
            storageBucket: "carrera-constitucional.firebasestorage.app",
            messagingSenderId: "627786732121",
            appId: "1:627786732121:web:9f1cc7c0b94887a9501b48"
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        let gameId = null, playerNumber = null, currentArticle = null, currentArticleIndex = 0;
        let player1Fuel = 0, player2Fuel = 0, player1Position = 0, player2Position = 0;
        let currentQuestion = 0, usedArticles = [], articleInterval = null;

        const articles = [
            { number: 1, title: "Art√≠culo 1", text: "1. Espa√±a se constituye en un Estado social y democr√°tico de Derecho...\n2. La soberan√≠a nacional reside en el pueblo espa√±ol...\n3. La forma pol√≠tica es la Monarqu√≠a parlamentaria.", questions: [{q:"¬øValor superior?", options:["Libertad","Fraternidad","Igualdad","Pluralismo"], correct:1},{q:"¬øReside la soberan√≠a?", options:["Rey","Pueblo","Cortes","Gobierno"], correct:1},{q:"¬øForma pol√≠tica?", options:["Rep√∫blica","Absoluta","Monarqu√≠a Parl.","Presidencial"], correct:2},{q:"¬øEstado?", options:["Liberal","Social y Democ.","Federal","Confesional"], correct:1},{q:"¬øDe qui√©n emanan los poderes?", options:["Const.","Pueblo","Rey","Parl."], correct:1}] },
            { number: 2, title: "Art√≠culo 2", text: "La Constituci√≥n se fundamenta en la indisoluble unidad de la Naci√≥n espa√±ola...", questions: [{q:"¬øFundamento?", options:["Diversidad","Unidad","Foral","Monarqu√≠a"], correct:1},{q:"¬øQu√© reconoce?", options:["Independencia","Autonom√≠a","Soberan√≠a","Separaci√≥n"], correct:1},{q:"Naci√≥n es:", options:["Divisible","Com√∫n e indivisible","Federal","Regional"], correct:1},{q:"Principio:", options:["Competencia","Solidaridad","Indep.","Jerarqu√≠a"], correct:1},{q:"Unidad es:", options:["Reversible","Indisoluble","Temporal","Condicional"], correct:1}] },
            { number: 3, title: "Art√≠culo 3", text: "El castellano es la lengua espa√±ola oficial del Estado...", questions: [{q:"Oficial:", options:["Espa√±ol","Castellano","Ib√©rico","Todas"], correct:1},{q:"Derecho y deber:", options:["Usar","Conocer y usar","Solo conocer","Aprender"], correct:1},{q:"Dem√°s lenguas:", options:["Todo el pa√≠s","En sus CCAA","Solo local","No oficial"], correct:1},{q:"Modalidades:", options:["Problema","Patrimonio","Admin.","Derecho"], correct:1},{q:"Protecci√≥n:", options:["B√°sica","Especial","Opcional","Ninguna"], correct:1}] },
            { number: 4, title: "Art√≠culo 4", text: "Bandera: tres franjas horizontales, roja, amarilla y roja...", questions: [{q:"Franjas:", options:["2","3","4","5"], correct:1},{q:"Doble ancho:", options:["Roja sup.","Amarilla","Roja inf.","Iguales"], correct:1},{q:"CCAA:", options:["No","Si Estatuto","D√≠as fiesta","Interior"], correct:1},{q:"Uso CCAA:", options:["Solas","Junto a Espa√±a","Privado","No usar"], correct:1},{q:"Colores:", options:["R/A","R/A/Azul","R/A/R","A/V/R"], correct:2}] },
            { number: 5, title: "Art√≠culo 5", text: "La capital del Estado es la villa de Madrid.", questions: [{q:"Capital:", options:["BCN","Madrid","SVQ","VLC"], correct:1},{q:"Madrid es:", options:["Ciudad","Villa","Municipio","Provincia"], correct:1},{q:"¬øCambiar?", options:["Ley ord.","Reforma","Decreto","No"], correct:1},{q:"Constitucional:", options:["1492","1978","1931","1812"], correct:1},{q:"Art. 5 es:", options:["Largo","Corto","Medio","No"], correct:1}] },
            { number: 6, title: "Art√≠culo 6", text: "Partidos expresan pluralismo pol√≠tico...", questions: [{q:"Expresan:", options:["Soc.","Pol√≠t.","Nac.","Reg."], correct:1},{q:"Instrumento:", options:["Gob.","Part. Pol√≠t.","Admin.","Juez"], correct:1},{q:"Creaci√≥n:", options:["Sin fin","Respeto Const.","Autoriz.","L√≠mite"], correct:1},{q:"Funcionamiento:", options:["Jer√°r.","Democ.","Auto.","No"], correct:1},{q:"Concurren:", options:["Gob.","Voluntad Pop.","Mun.","Juez"], correct:1}] },
            { number: 7, title: "Art√≠culo 7", text: "Sindicatos y asociaciones empresariales...", questions: [{q:"Sindicatos:", options:["Pol√≠t.","Econ/Soc","Cult.","Relig."], correct:1},{q:"Creaci√≥n:", options:["No","Si Const.","Autoriz.","P√∫blico"], correct:1},{q:"Empresas:", options:["Pol√≠t.","Econ/Soc propios","Gob.","P√∫blico"], correct:1},{q:"Estructura:", options:["Auto","Democ","Jer√°r","No"], correct:1},{q:"Art trata:", options:["Sindicatos","Empresas","Ambos","Partidos"], correct:2}] },
            { number: 8, title: "Art√≠culo 8", text: "Fuerzas Armadas: Tierra, Armada y Aire...", questions: [{q:"Ej√©rcitos:", options:["2","3","4","5"], correct:1},{q:"NO es rama:", options:["Tierra","G. Civil","Armada","Aire"], correct:1},{q:"Misi√≥n:", options:["Soberan√≠a","Gobierno","Ley","Juez"], correct:0},{q:"Ley:", options:["Ord.","Org√°n.","Decreto","Real"], correct:1},{q:"Defienden:", options:["Territ.","Const.","Gob.","Rey"], correct:1}] },
            { number: 9, title: "Art√≠culo 9", text: "Ciudadanos y poderes sujetos a Constituci√≥n...", questions: [{q:"Sujetos:", options:["Solo ciud.","Solo pod.","Ambos","Gob."], correct:2},{q:"Promover:", options:["Desigual","Igualdad real","Econ.","Jerar."], correct:1},{q:"Principio:", options:["Oportun.","Legalidad","Conven.","Disc."], correct:1},{q:"Favorables:", options:["No","Si","Juez","No espec."], correct:1},{q:"Prohibe:", options:["Partic.","Arbitrariedad","Segur.","Jerar."], correct:1}] }
        ];

        function createGame() {
            gameId = Math.floor(1000 + Math.random() * 9000).toString();
            playerNumber = 1;
            database.ref('games/' + gameId).set({ player1: true, player2: false, gameState: 'lobby', player1Position: 0, player2Position: 0 });
            document.getElementById('lobbyScreen').querySelector('.lobby-options').style.display = 'none';
            document.getElementById('gameCreatedDiv').classList.remove('hidden');
            document.getElementById('gameCodeDisplay').textContent = gameId;
            listenToGame();
        }

        function showJoinGame() { document.getElementById('joinGameDiv').classList.remove('hidden'); }

        function joinGame() {
            const code = document.getElementById('gameCodeInput').value;
            database.ref('games/' + code).once('value', s => {
                if (!s.val() || s.val().player2) return alert("Error en sala");
                gameId = code; playerNumber = 2;
                database.ref('games/' + code).update({ player2: true });
                listenToGame();
            });
        }

        function listenToGame() {
            database.ref('games/' + gameId).on('value', s => {
                const game = s.val();
                if (!game) return;
                
                if (game.player2) {
                    document.getElementById('player2Status').classList.add('ready');
                    document.getElementById('player2Status').innerHTML = '<span>‚úÖ</span><span>Jugador 2 Listo</span>';
                    if (game.gameState === 'lobby') showWelcome();
                }

                if (game.gameState === 'article') {
                    if (!currentArticle || articles.indexOf(currentArticle) !== game.currentArticleIndex) {
                        currentArticle = articles[game.currentArticleIndex];
                        currentArticleIndex = game.currentArticleIndex + 1;
                        hideAll();
                        showArticle();
                    }
                }

                if (game.player1Finished && game.player2Finished && game.gameState !== 'race') {
                    if (playerNumber === 1) database.ref('games/' + gameId).update({ gameState: 'race', player1Finished: false, player2Finished: false });
                }

                if (game.gameState === 'race') {
                    hideAll();
                    document.getElementById('battleScreen').style.display = 'block';
                    player1Fuel = game.player1Fuel || 0; player2Fuel = game.player2Fuel || 0;
                    player1Position = game.player1Position || 0; player2Position = game.player2Position || 0;
                    updateRaceVisuals();
                }
            });
        }

        function showWelcome() {
            document.getElementById('lobbyScreen').style.display = 'none';
            document.getElementById('welcomeScreen').style.display = 'block';
            if (playerNumber === 2) {
                document.getElementById('startBtn').classList.add('hidden');
                document.getElementById('waitingForStart').classList.remove('hidden');
            }
        }

        function startGame() {
            if (playerNumber !== 1) return;
            const idx = Math.floor(Math.random() * articles.length);
            database.ref('games/' + gameId).update({ gameState: 'article', currentArticleIndex: idx, player1Finished: false, player2Finished: false });
        }

        function showArticle() {
            document.getElementById('articleBox').innerHTML = `<h3>${currentArticle.title}</h3><p style="white-space: pre-line;">${currentArticle.text}</p>`;
            document.getElementById('articleScreen').style.display = 'block';
            let tl = 30; document.getElementById('timeLeft').textContent = tl;
            if (articleInterval) clearInterval(articleInterval);
            articleInterval = setInterval(() => {
                tl--; document.getElementById('timeLeft').textContent = tl;
                if (tl <= 0) { clearInterval(articleInterval); startQuiz(); }
            }, 1000);
        }

        function startQuiz() {
            hideAll();
            document.getElementById('quizScreen').style.display = 'block';
            currentQuestion = 0; player1Fuel = 0; player2Fuel = 0;
            showQuestion();
        }

        function showQuestion() {
            const q = currentArticle.questions[currentQuestion];
            document.getElementById('currentPlayerName').textContent = `T√∫ (J${playerNumber})`;
            document.getElementById('questionText').textContent = q.q;
            const cont = document.getElementById('optionsContainer'); cont.innerHTML = '';
            q.options.forEach((o, i) => {
                const d = document.createElement('div'); d.className = 'option'; d.textContent = o;
                d.onclick = () => {
                    const opts = document.querySelectorAll('.option');
                    opts.forEach(p => p.style.pointerEvents = 'none');
                    if (i === q.correct) { d.classList.add('correct'); if(playerNumber===1) player1Fuel+=20; else player2Fuel+=20; }
                    else { d.classList.add('incorrect'); opts[q.correct].classList.add('correct'); }
                    document.getElementById('fuelText').textContent = (playerNumber===1?player1Fuel:player2Fuel) + "m";
                    document.getElementById('fuelFill').style.width = ((playerNumber===1?player1Fuel:player2Fuel)) + "%";
                    document.getElementById('nextBtn').style.display = 'block';
                };
                cont.appendChild(d);
            });
            document.getElementById('nextBtn').style.display = 'none';
        }

        function nextQuestion() {
            currentQuestion++;
            if (currentQuestion < 5) showQuestion();
            else {
                hideAll(); document.getElementById('waitingScreen').style.display = 'block';
                document.getElementById('myScore').textContent = playerNumber===1?player1Fuel:player2Fuel;
                const up = {}; up[`player${playerNumber}Finished`] = true; up[`player${playerNumber}Fuel`] = playerNumber===1?player1Fuel:player2Fuel;
                database.ref('games/' + gameId).update(up);
            }
        }

        function updateRaceVisuals() {
            const track = document.getElementById('racetrack').offsetWidth - 150;
            document.getElementById('raceTitle').textContent = `Resultados Etapa`;
            
            // Animaci√≥n
            document.getElementById('horse1').classList.add('moving');
            document.getElementById('horse2').classList.add('moving');
            
            player1Position += player1Fuel; player2Position += player2Fuel;
            
            setTimeout(() => {
                document.getElementById('horse1').style.left = (60 + (player1Position/900 * track)) + 'px';
                document.getElementById('horse2').style.left = (60 + (player2Position/900 * track)) + 'px';
                document.getElementById('distance1').textContent = player1Position + 'm';
                document.getElementById('distance2').textContent = player2Position + 'm';
                document.getElementById('progress1').style.width = (player1Position/900 * 100) + '%';
                document.getElementById('progress2').style.width = (player2Position/900 * 100) + '%';
                document.getElementById('progressText1').textContent = player1Position + 'm';
                document.getElementById('progressText2').textContent = player2Position + 'm';
                
                document.getElementById('horse1').classList.remove('moving');
                document.getElementById('horse2').classList.remove('moving');

                if (player1Position >= 900 || player2Position >= 900) {
                    hideAll(); document.getElementById('winnerScreen').style.display = 'block';
                    document.getElementById('winnerText').textContent = player1Position > player2Position ? "¬°Gana Jugador 1!" : "¬°Gana Jugador 2!";
                }
            }, 500);

            if (playerNumber === 1) database.ref('games/' + gameId).update({ player1Position, player2Position, player1Fuel:0, player2Fuel:0 });
        }

        function continueRace() {
            if (playerNumber === 1) startGame();
        }

        function hideAll() {
            ['lobbyScreen','welcomeScreen','articleScreen','quizScreen','waitingScreen','battleScreen','winnerScreen'].forEach(id => {
                document.getElementById(id).style.display = 'none';
            });
        }
    </script>
</body>
</html>