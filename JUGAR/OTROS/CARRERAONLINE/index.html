<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Batalla Constitucional Online - T√≠tulo Preliminar</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow-x: hidden;
        }

        .container {
            max-width: 900px;
            width: 95%;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            padding: 30px;
            text-align: center;
            color: white;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.95;
        }

        .player-indicator {
            background: rgba(255, 255, 255, 0.2);
            padding: 10px 25px;
            border-radius: 25px;
            font-size: 1.2em;
            font-weight: bold;
            margin-top: 15px;
            display: none;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .content {
            padding: 40px;
        }

        /* Pantalla de lobby */
        .lobby-screen {
            text-align: center;
        }

        .lobby-screen h2 {
            color: #667eea;
            font-size: 2em;
            margin-bottom: 20px;
        }

        .lobby-screen p {
            color: #666;
            font-size: 1.1em;
            line-height: 1.8;
            margin-bottom: 30px;
        }

        .lobby-options {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-bottom: 30px;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.2em;
            border-radius: 50px;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);
        }

        .input-group {
            margin: 20px 0;
        }

        .input-group input {
            padding: 15px 20px;
            font-size: 1.2em;
            border: 2px solid #ddd;
            border-radius: 10px;
            width: 300px;
            text-align: center;
            text-transform: uppercase;
        }

        .input-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .game-code {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .game-code h3 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .game-code .code {
            font-size: 3em;
            font-weight: bold;
            color: #f5576c;
            letter-spacing: 10px;
            font-family: 'Courier New', monospace;
        }

        .waiting-message {
            color: #666;
            font-size: 1.2em;
            margin: 20px 0;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .players-status {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .player-slot {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            margin: 5px 0;
            background: white;
            border-radius: 5px;
        }

        .player-slot.ready {
            background: #84fab0;
        }

        /* Pantalla de bienvenida */
        .welcome-screen {
            text-align: center;
            display: none;
        }

        .welcome-screen h2 {
            color: #667eea;
            font-size: 2em;
            margin-bottom: 20px;
        }

        .welcome-screen p {
            color: #666;
            font-size: 1.1em;
            line-height: 1.8;
            margin-bottom: 30px;
        }

        /* Pantalla de art√≠culo */
        .article-screen {
            display: none;
        }

        .article-box {
            background: #f8f9fa;
            border-left: 5px solid #667eea;
            padding: 25px;
            margin-bottom: 30px;
            border-radius: 10px;
        }

        .article-box h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.5em;
        }

        .article-box p {
            color: #333;
            line-height: 1.8;
            font-size: 1.1em;
        }

        .timer-box {
            background: #fff3cd;
            border: 2px solid #ffc107;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 20px;
        }

        .timer-box h3 {
            color: #856404;
            margin-bottom: 5px;
        }

        .timer-box .time {
            font-size: 3em;
            font-weight: bold;
            color: #f5576c;
        }

        /* Pantalla de quiz */
        .quiz-screen {
            display: none;
        }

        .question-box {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 25px;
        }

        .question-box h3 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.3em;
        }

        .options-container {
            display: grid;
            gap: 15px;
        }

        .option {
            background: white;
            padding: 20px;
            border: 2px solid #ddd;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1.1em;
        }

        .option:hover {
            border-color: #667eea;
            background: #f0f4ff;
            transform: translateX(5px);
        }

        .option.correct {
            background: #84fab0;
            border-color: #28a745;
            animation: correctPulse 0.5s;
        }

        .option.incorrect {
            background: #ffb3ba;
            border-color: #dc3545;
            animation: shake 0.5s;
        }

        @keyframes correctPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        .fuel-meter {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .fuel-meter h3 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .fuel-bar {
            background: #e9ecef;
            height: 30px;
            border-radius: 15px;
            overflow: hidden;
            position: relative;
        }

        .fuel-fill {
            background: linear-gradient(90deg, #84fab0 0%, #8fd3f4 100%);
            height: 100%;
            width: 0%;
            transition: width 0.5s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        /* Pantalla de espera */
        .waiting-screen {
            text-align: center;
            display: none;
        }

        .waiting-screen h2 {
            color: #667eea;
            font-size: 2em;
            margin-bottom: 20px;
        }

        .score-display {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 15px;
            margin: 20px 0;
        }

        .score-display .score {
            font-size: 4em;
            font-weight: bold;
            color: #f5576c;
        }

        /* Pantalla de batalla */
        .battle-screen {
            display: none;
        }

        .race-track {
            background: linear-gradient(to bottom, 
                #8bc34a 0%, 
                #7cb342 50%, 
                #689f38 100%);
            height: 300px;
            position: relative;
            border-radius: 15px;
            overflow: hidden;
            margin: 30px 0;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.2);
        }

        .finish-line {
            position: absolute;
            right: 20px;
            top: 0;
            bottom: 0;
            width: 30px;
            background: repeating-linear-gradient(
                45deg,
                #000,
                #000 10px,
                #fff 10px,
                #fff 20px
            );
        }

        .lane {
            position: absolute;
            width: 100%;
            height: 50%;
            display: flex;
            align-items: center;
        }

        .lane:first-child {
            top: 0;
            border-bottom: 3px dashed rgba(255,255,255,0.5);
        }

        .lane:last-child {
            bottom: 0;
        }

        .horse {
            position: absolute;
            left: 60px;
            font-size: 50px;
            transition: left 2s ease-out;
            filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.3));
        }

        .horse.moving {
            animation: gallop 0.5s steps(2) infinite;
        }

        @keyframes gallop {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .distance-label {
            position: absolute;
            right: 10px;
            background: rgba(255,255,255,0.9);
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            color: #667eea;
            font-size: 1.2em;
        }

        .progress-bars {
            margin-top: 30px;
        }

        .progress-item {
            margin-bottom: 20px;
        }

        .progress-item h4 {
            color: #667eea;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
        }

        .progress-bar {
            background: #e9ecef;
            height: 25px;
            border-radius: 15px;
            overflow: hidden;
        }

        .progress-fill {
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            height: 100%;
            width: 0%;
            transition: width 2s ease-out;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 10px;
            color: white;
            font-weight: bold;
        }

        /* Pantalla de ganador */
        .winner-screen {
            text-align: center;
            display: none;
        }

        .winner-screen h2 {
            color: #f5576c;
            font-size: 3em;
            margin-bottom: 30px;
            animation: bounce 1s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }

        .trophy {
            font-size: 8em;
            margin: 30px 0;
            animation: rotate 2s infinite;
        }

        @keyframes rotate {
            0% { transform: rotate(0deg); }
            25% { transform: rotate(-10deg); }
            75% { transform: rotate(10deg); }
            100% { transform: rotate(0deg); }
        }

        .hidden {
            display: none !important;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8em;
            }
            
            .lobby-options {
                flex-direction: column;
            }
            
            .race-track {
                height: 200px;
            }
            
            .horse {
                font-size: 30px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üèõÔ∏è Batalla Constitucional üèõÔ∏è</h1>
            <p>T√≠tulo Preliminar - Juego Multijugador Online</p>
            <div id="playerIndicator" class="player-indicator"></div>
        </div>

        <div class="content">
            <!-- Pantalla de Lobby -->
            <div id="lobbyScreen" class="lobby-screen">
                <h2>¬°Bienvenido!</h2>
                <p>Elige c√≥mo quieres jugar:</p>
                
                <div class="lobby-options">
                    <button class="btn" onclick="createGame()">Crear Partida</button>
                    <button class="btn btn-secondary" onclick="showJoinGame()">Unirse a Partida</button>
                </div>

                <div id="createGameSection" class="hidden">
                    <div class="game-code">
                        <h3>C√≥digo de la Partida:</h3>
                        <div id="gameCodeDisplay" class="code"></div>
                    </div>
                    <p class="waiting-message">Esperando al segundo jugador...</p>
                    <div class="players-status">
                        <div class="player-slot ready">üë§ Jugador 1: Conectado</div>
                        <div id="player2Status" class="player-slot">üë§ Jugador 2: Esperando...</div>
                    </div>
                </div>

                <div id="joinGameSection" class="hidden">
                    <div class="input-group">
                        <input type="text" id="gameCodeInput" placeholder="Ingresa el c√≥digo" maxlength="6">
                    </div>
                    <button class="btn" onclick="joinGame()">Unirse</button>
                </div>
            </div>

            <!-- Pantalla de Bienvenida -->
            <div id="welcomeScreen" class="welcome-screen">
                <h2>¬°Que comience la batalla!</h2>
                <p>Van a competir leyendo art√≠culos de la Constituci√≥n y respondiendo preguntas.</p>
                <p>Por cada respuesta correcta avanzan 20 metros. ¬°El primero en llegar a 900m gana!</p>
                <button id="startBtn" class="btn" onclick="startGame()">Iniciar Juego</button>
                <p id="waitingForStart" class="waiting-message hidden">Esperando a que el Jugador 1 inicie...</p>
            </div>

            <!-- Pantalla de Art√≠culo -->
            <div id="articleScreen" class="article-screen">
                <div class="timer-box">
                    <h3>‚è±Ô∏è Tiempo para leer:</h3>
                    <div id="timeLeft" class="time">30</div>
                </div>
                <div id="articleBox" class="article-box"></div>
            </div>

            <!-- Pantalla de Quiz -->
            <div id="quizScreen" class="quiz-screen">
                <div class="question-box">
                    <h3>Pregunta para: <span id="currentPlayerName"></span></h3>
                    <p id="questionText" style="font-size: 1.2em; margin-top: 15px;"></p>
                </div>
                <div id="optionsContainer" class="options-container"></div>
                <div class="fuel-meter">
                    <h3>üèÅ Tu combustible acumulado:</h3>
                    <div class="fuel-bar">
                        <div id="fuelFill" class="fuel-fill">
                            <span id="fuelText">0m</span>
                        </div>
                    </div>
                </div>
                <button id="nextBtn" class="btn" onclick="nextQuestion()" style="display: none; margin-top: 20px;">Siguiente ‚û°Ô∏è</button>
            </div>

            <!-- Pantalla de Espera -->
            <div id="waitingScreen" class="waiting-screen">
                <h2>‚úÖ ¬°Cuestionario Completado!</h2>
                <div class="score-display">
                    <p>Has obtenido:</p>
                    <div id="myScore" class="score">0m</div>
                </div>
                <p class="waiting-message">Esperando al otro jugador...</p>
            </div>

            <!-- Pantalla de Batalla -->
            <div id="battleScreen" class="battle-screen">
                <h2 id="raceTitle" style="text-align: center; color: #667eea; margin-bottom: 20px;">Resultados Etapa</h2>
                <div id="racetrack" class="race-track">
                    <div class="finish-line"></div>
                    <div class="lane">
                        <div id="horse1" class="horse">üêé</div>
                        <div id="distance1" class="distance-label">0m</div>
                    </div>
                    <div class="lane">
                        <div id="horse2" class="horse">ü¶Ñ</div>
                        <div id="distance2" class="distance-label">0m</div>
                    </div>
                </div>
                <div class="progress-bars">
                    <div class="progress-item">
                        <h4>
                            <span>üêé Jugador 1</span>
                            <span id="progressText1">0m</span>
                        </h4>
                        <div class="progress-bar">
                            <div id="progress1" class="progress-fill"></div>
                        </div>
                    </div>
                    <div class="progress-item">
                        <h4>
                            <span>ü¶Ñ Jugador 2</span>
                            <span id="progressText2">0m</span>
                        </h4>
                        <div class="progress-bar">
                            <div id="progress2" class="progress-fill"></div>
                        </div>
                    </div>
                </div>
                <button class="btn" onclick="continueRace()" style="margin-top: 30px; width: 100%;">Continuar ‚û°Ô∏è</button>
            </div>

            <!-- Pantalla de Ganador -->
            <div id="winnerScreen" class="winner-screen">
                <h2 id="winnerText"></h2>
                <div class="trophy">üèÜ</div>
                <p style="font-size: 1.3em; color: #666; margin: 20px 0;">¬°Partida completada!</p>
                <button class="btn" onclick="location.reload()">Nueva Partida üîÑ</button>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDGV4R0RqNdUTFLF-vBTXj-B-S0wrOPbz0",
            authDomain: "opos-93d39.firebaseapp.com",
            databaseURL: "https://opos-93d39-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "opos-93d39",
            storageBucket: "opos-93d39.firebasestorage.app",
            messagingSenderId: "730486951447",
            appId: "1:730486951447:web:79ac9d2e13667a9dd868d2"
        };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        const articles = [
            {
                title: "Art√≠culo 1",
                text: "1. Espa√±a se constituye en un Estado social y democr√°tico de Derecho, que propugna como valores superiores de su ordenamiento jur√≠dico la libertad, la justicia, la igualdad y el pluralismo pol√≠tico.\n\n2. La soberan√≠a nacional reside en el pueblo espa√±ol, del que emanan los poderes del Estado.\n\n3. La forma pol√≠tica del Estado espa√±ol es la Monarqu√≠a parlamentaria.",
                questions: [
                    { q: "¬øCu√°l de estos NO es un valor superior del ordenamiento jur√≠dico espa√±ol?", options: ["La libertad", "La seguridad", "La justicia", "La igualdad"], correct: 1 },
                    { q: "¬øEn qui√©n reside la soberan√≠a nacional?", options: ["En el Rey", "En el pueblo espa√±ol", "En las Cortes", "En el Gobierno"], correct: 1 },
                    { q: "¬øQu√© forma pol√≠tica tiene el Estado espa√±ol?", options: ["Rep√∫blica", "Monarqu√≠a absoluta", "Monarqu√≠a parlamentaria", "Estado federal"], correct: 2 },
                    { q: "¬øQu√© tipo de Estado es Espa√±a seg√∫n el art√≠culo 1?", options: ["Estado confesional", "Estado social y democr√°tico de Derecho", "Estado liberal", "Estado totalitario"], correct: 1 },
                    { q: "¬øDe d√≥nde emanan los poderes del Estado?", options: ["De la Corona", "Del Gobierno", "Del pueblo espa√±ol", "De las Comunidades Aut√≥nomas"], correct: 2 }
                ]
            },
            {
                title: "Art√≠culo 2",
                text: "La Constituci√≥n se fundamenta en la indisoluble unidad de la Naci√≥n espa√±ola, patria com√∫n e indivisible de todos los espa√±oles, y reconoce y garantiza el derecho a la autonom√≠a de las nacionalidades y regiones que la integran y la solidaridad entre todas ellas.",
                questions: [
                    { q: "¬øQu√© reconoce la Constituci√≥n a las nacionalidades y regiones?", options: ["El derecho a la independencia", "El derecho a la autonom√≠a", "El derecho a la secesi√≥n", "El derecho al veto"], correct: 1 },
                    { q: "La Constituci√≥n se fundamenta en:", options: ["La divisi√≥n de Espa√±a", "La unidad de la Naci√≥n espa√±ola", "El federalismo", "El centralismo"], correct: 1 },
                    { q: "¬øQu√© principio se garantiza entre las nacionalidades y regiones?", options: ["La competencia", "La solidaridad", "La independencia", "La jerarqu√≠a"], correct: 1 },
                    { q: "¬øC√≥mo califica la Constituci√≥n a la Naci√≥n espa√±ola?", options: ["Divisible", "Indisoluble", "Federal", "Confederal"], correct: 1 },
                    { q: "La Naci√≥n espa√±ola es descrita como:", options: ["Patria com√∫n e indivisible", "Conjunto de regiones independientes", "Estado federal", "Uni√≥n de nacionalidades"], correct: 0 }
                ]
            },
            {
                title: "Art√≠culo 3",
                text: "1. El castellano es la lengua espa√±ola oficial del Estado. Todos los espa√±oles tienen el deber de conocerla y el derecho a usarla.\n\n2. Las dem√°s lenguas espa√±olas ser√°n tambi√©n oficiales en las respectivas Comunidades Aut√≥nomas de acuerdo con sus Estatutos.\n\n3. La riqueza de las distintas modalidades ling√º√≠sticas de Espa√±a es un patrimonio cultural que ser√° objeto de especial respeto y protecci√≥n.",
                questions: [
                    { q: "¬øCu√°l es la lengua oficial del Estado espa√±ol?", options: ["El espa√±ol", "El castellano", "El catal√°n", "Todas las anteriores"], correct: 1 },
                    { q: "¬øQu√© obligaci√≥n tienen los espa√±oles respecto al castellano?", options: ["Deber de conocerla", "Deber de ense√±arla", "Ninguna", "Deber de promoverla"], correct: 0 },
                    { q: "¬øD√≥nde pueden ser oficiales las dem√°s lenguas espa√±olas?", options: ["En todo el Estado", "En las respectivas Comunidades Aut√≥nomas", "Solo en el √°mbito privado", "Nunca"], correct: 1 },
                    { q: "Las modalidades ling√º√≠sticas son consideradas:", options: ["Un problema", "Patrimonio cultural", "Innecesarias", "Secundarias"], correct: 1 },
                    { q: "La oficialidad de las lenguas auton√≥micas se establece seg√∫n:", options: ["La Constituci√≥n directamente", "Los Estatutos de Autonom√≠a", "Ley ordinaria", "Decreto"], correct: 1 }
                ]
            },
            {
                title: "Art√≠culo 4",
                text: "1. La bandera de Espa√±a est√° formada por tres franjas horizontales, roja, amarilla y roja, siendo la amarilla de doble anchura que cada una de las rojas.\n\n2. Los Estatutos podr√°n reconocer banderas y ense√±as propias de las Comunidades Aut√≥nomas. Estas se utilizar√°n junto a la bandera de Espa√±a en sus edificios p√∫blicos y en sus actos oficiales.",
                questions: [
                    { q: "¬øCu√°ntas franjas tiene la bandera de Espa√±a?", options: ["Dos", "Tres", "Cuatro", "Cinco"], correct: 1 },
                    { q: "¬øQu√© anchura tiene la franja amarilla comparada con las rojas?", options: ["Igual anchura", "Doble anchura", "Triple anchura", "Mitad de anchura"], correct: 1 },
                    { q: "¬øPueden las Comunidades Aut√≥nomas tener banderas propias?", options: ["No", "S√≠, si lo reconocen sus Estatutos", "Solo con permiso del Rey", "Solo en fiestas"], correct: 1 },
                    { q: "¬øC√≥mo deben usarse las banderas auton√≥micas en edificios p√∫blicos?", options: ["Solas", "Junto a la bandera de Espa√±a", "Altern√°ndolas", "Solo los festivos"], correct: 1 },
                    { q: "¬øDe qu√© colores es la bandera espa√±ola seg√∫n la Constituci√≥n?", options: ["Rojo, amarillo y azul", "Rojo, amarillo y rojo", "Amarillo y rojo", "Rojo y gualda"], correct: 1 }
                ]
            },
            {
                title: "Art√≠culo 5",
                text: "La capital del Estado es la villa de Madrid.",
                questions: [
                    { q: "¬øCu√°l es la capital del Estado espa√±ol?", options: ["Barcelona", "Madrid", "Sevilla", "Valencia"], correct: 1 },
                    { q: "¬øC√≥mo denomina la Constituci√≥n a Madrid?", options: ["Ciudad", "Villa", "Municipio", "Metr√≥poli"], correct: 1 },
                    { q: "¬øPuede cambiarse la capital seg√∫n la Constituci√≥n?", options: ["S√≠, por ley ordinaria", "S√≠, por reforma constitucional", "No", "S√≠, por decreto"], correct: 1 },
                    { q: "¬øQu√© art√≠culo establece la capital del Estado?", options: ["Art√≠culo 1", "Art√≠culo 3", "Art√≠culo 5", "Art√≠culo 10"], correct: 2 },
                    { q: "La denominaci√≥n 'villa' aplicada a Madrid es:", options: ["Informal", "Constitucional", "Hist√≥rica solamente", "Incorrecta"], correct: 1 }
                ]
            },
            {
                title: "Art√≠culo 6",
                text: "Los partidos pol√≠ticos expresan el pluralismo pol√≠tico, concurren a la formaci√≥n y manifestaci√≥n de la voluntad popular y son instrumento fundamental para la participaci√≥n pol√≠tica. Su creaci√≥n y el ejercicio de su actividad son libres dentro del respeto a la Constituci√≥n y a la ley. Su estructura interna y funcionamiento deber√°n ser democr√°ticos.",
                questions: [
                    { q: "¬øQu√© expresan los partidos pol√≠ticos?", options: ["El poder judicial", "El pluralismo pol√≠tico", "La voluntad del Rey", "La unidad nacional"], correct: 1 },
                    { q: "¬øC√≥mo debe ser la estructura interna de los partidos?", options: ["Jer√°rquica", "Democr√°tica", "Autoritaria", "Libre"], correct: 1 },
                    { q: "Los partidos pol√≠ticos son instrumento fundamental para:", options: ["El Gobierno", "La participaci√≥n pol√≠tica", "La Corona", "La justicia"], correct: 1 },
                    { q: "La creaci√≥n de partidos es:", options: ["Prohibida", "Libre dentro del respeto a la Constituci√≥n y la ley", "Solo permitida con autorizaci√≥n", "Limitada"], correct: 1 },
                    { q: "¬øA qu√© concurren los partidos pol√≠ticos?", options: ["A la formaci√≥n del Gobierno solamente", "A la formaci√≥n y manifestaci√≥n de la voluntad popular", "A la elaboraci√≥n de leyes", "Al control judicial"], correct: 1 }
                ]
            },
            {
                title: "Art√≠culo 7",
                text: "Los sindicatos de trabajadores y las asociaciones empresariales contribuyen a la defensa y promoci√≥n de los intereses econ√≥micos y sociales que les son propios. Su creaci√≥n y el ejercicio de su actividad son libres dentro del respeto a la Constituci√≥n y a la ley. Su estructura interna y funcionamiento deber√°n ser democr√°ticos.",
                questions: [
                    { q: "¬øQu√© defienden los sindicatos?", options: ["Intereses pol√≠ticos", "Intereses econ√≥micos y sociales de los trabajadores", "Intereses del Estado", "Intereses judiciales"], correct: 1 },
                    { q: "¬øC√≥mo debe ser el funcionamiento interno de los sindicatos?", options: ["Autoritario", "Democr√°tico", "Jer√°rquico", "Libre"], correct: 1 },
                    { q: "La creaci√≥n de sindicatos es:", options: ["Prohibida", "Libre dentro del respeto a la Constituci√≥n", "Solo permitida con autorizaci√≥n", "Restringida"], correct: 1 },
                    { q: "¬øQu√© entidades se mencionan junto a los sindicatos?", options: ["Partidos pol√≠ticos", "Asociaciones empresariales", "ONGs", "Fundaciones"], correct: 1 },
                    { q: "Los sindicatos contribuyen a:", options: ["Formar el Gobierno", "Defender intereses econ√≥micos y sociales propios", "Legislar", "Juzgar"], correct: 1 }
                ]
            },
            {
                title: "Art√≠culo 8",
                text: "1. Las Fuerzas Armadas, constituidas por el Ej√©rcito de Tierra, la Armada y el Ej√©rcito del Aire, tienen como misi√≥n garantizar la soberan√≠a e independencia de Espa√±a, defender su integridad territorial y el ordenamiento constitucional.\n\n2. Una ley org√°nica regular√° las bases de la organizaci√≥n militar conforme a los principios de la presente Constituci√≥n.",
                questions: [
                    { q: "¬øCu√°ntos ej√©rcitos componen las Fuerzas Armadas seg√∫n el art√≠culo?", options: ["Dos", "Tres", "Cuatro", "Cinco"], correct: 1 },
                    { q: "¬øCu√°l NO es una misi√≥n de las Fuerzas Armadas?", options: ["Garantizar la soberan√≠a", "Defender la integridad territorial", "Formar el Gobierno", "Defender el ordenamiento constitucional"], correct: 2 },
                    { q: "¬øQu√© tipo de ley regula la organizaci√≥n militar?", options: ["Ley ordinaria", "Ley org√°nica", "Decreto-ley", "Real Decreto"], correct: 1 },
                    { q: "Los tres ej√©rcitos mencionados son:", options: ["Tierra, Mar y Aire", "Tierra, Armada y Aire", "Infanter√≠a, Marina y Aviaci√≥n", "Ej√©rcito, Marina y Aviaci√≥n"], correct: 1 },
                    { q: "Las Fuerzas Armadas deben defender:", options: ["Solo el territorio", "Solo la Constituci√≥n", "La soberan√≠a, integridad territorial y ordenamiento constitucional", "Solo al Gobierno"], correct: 2 }
                ]
            },
            {
                title: "Art√≠culo 9.1",
                text: "Los ciudadanos y los poderes p√∫blicos est√°n sujetos a la Constituci√≥n y al resto del ordenamiento jur√≠dico.",
                questions: [
                    { q: "¬øQui√©nes est√°n sujetos a la Constituci√≥n?", options: ["Solo los ciudadanos", "Solo los poderes p√∫blicos", "Ciudadanos y poderes p√∫blicos", "Solo el Gobierno"], correct: 2 },
                    { q: "Adem√°s de la Constituci√≥n, ¬øa qu√© m√°s est√°n sujetos?", options: ["A los tratados internacionales solo", "Al ordenamiento jur√≠dico", "A las costumbres", "A nada m√°s"], correct: 1 },
                    { q: "Este principio se conoce como:", options: ["Separaci√≥n de poderes", "Sujeci√≥n al ordenamiento jur√≠dico", "Soberan√≠a popular", "Estado de Derecho"], correct: 1 },
                    { q: "¬øPueden los poderes p√∫blicos actuar al margen de la Constituci√≥n?", options: ["S√≠", "No", "Solo en emergencias", "Solo el Gobierno"], correct: 1 },
                    { q: "La sujeci√≥n a la Constituci√≥n es:", options: ["Opcional", "Obligatoria", "Recomendable", "Solo para ciudadanos"], correct: 1 }
                ]
            },
            {
                title: "Art√≠culo 9.2",
                text: "Corresponde a los poderes p√∫blicos promover las condiciones para que la libertad y la igualdad del individuo y de los grupos en que se integra sean reales y efectivas; remover los obst√°culos que impidan o dificulten su plenitud y facilitar la participaci√≥n de todos los ciudadanos en la vida pol√≠tica, econ√≥mica, cultural y social.",
                questions: [
                    { q: "¬øQu√© deben promover los poderes p√∫blicos?", options: ["Solo la libertad", "Condiciones para libertad e igualdad reales y efectivas", "Solo la igualdad", "La riqueza"], correct: 1 },
                    { q: "Los poderes p√∫blicos deben remover:", options: ["A los ciudadanos", "Los obst√°culos a libertad e igualdad", "Las leyes antiguas", "Los partidos"], correct: 1 },
                    { q: "Se debe facilitar la participaci√≥n en la vida:", options: ["Solo pol√≠tica", "Pol√≠tica, econ√≥mica, cultural y social", "Solo econ√≥mica", "Solo cultural"], correct: 1 },
                    { q: "¬øLa igualdad debe ser solo formal?", options: ["S√≠", "No, debe ser real y efectiva", "Depende", "Solo formal"], correct: 1 },
                    { q: "Este art√≠culo establece:", options: ["Igualdad formal", "Igualdad material o sustancial", "Solo deberes", "Prohibiciones"], correct: 1 }
                ]
            },
            {
                title: "Art√≠culo 9.3",
                text: "La Constituci√≥n garantiza el principio de legalidad, la jerarqu√≠a normativa, la publicidad de las normas, la irretroactividad de las disposiciones sancionadoras no favorables o restrictivas de derechos individuales, la seguridad jur√≠dica, la responsabilidad y la interdicci√≥n de la arbitrariedad de los poderes p√∫blicos.",
                questions: [
                    { q: "¬øCu√°l NO es un principio garantizado en este art√≠culo?", options: ["Principio de legalidad", "Jerarqu√≠a normativa", "Principio mon√°rquico", "Seguridad jur√≠dica"], correct: 2 },
                    { q: "¬øPueden las normas sancionadoras ser retroactivas si son favorables?", options: ["No, nunca", "S√≠", "Solo con autorizaci√≥n judicial", "Solo en casos excepcionales"], correct: 1 },
                    { q: "¬øQu√© se proh√≠be a los poderes p√∫blicos?", options: ["Legislar", "La arbitrariedad", "Gobernar", "Juzgar"], correct: 1 },
                    { q: "La publicidad de las normas significa:", options: ["Que deben anunciarse", "Que deben ser p√∫blicas y conocibles", "Que deben estar en TV", "Que son secretas"], correct: 1 },
                    { q: "¬øCu√°ntos principios se mencionan aproximadamente?", options: ["Tres", "Cinco", "Siete", "Dos"], correct: 2 }
                ]
            }
        ];

        let gameId = null;
        let playerNumber = null;
        let currentArticle = null;
        let currentQuestion = 0;
        let player1Fuel = 0, player2Fuel = 0;
        let player1Position = 0, player2Position = 0;
        let articleInterval = null;

        function createGame() {
            gameId = Math.random().toString(36).substring(2, 8).toUpperCase();
            playerNumber = 1;
            
            database.ref('games/' + gameId).set({
                player1: true,
                player2: false,
                gameState: 'waiting',
                usedArticles: []  // Array para guardar √≠ndices de art√≠culos ya usados
            });

            document.getElementById('gameCodeDisplay').textContent = gameId;
            document.getElementById('createGameSection').classList.remove('hidden');
            updatePlayerIndicator();

            database.ref('games/' + gameId).on('value', (snapshot) => {
                const game = snapshot.val();
                if (game && game.player2) {
                    document.getElementById('player2Status').classList.add('ready');
                    document.getElementById('player2Status').textContent = 'üë§ Jugador 2: Conectado';
                    setTimeout(() => {
                        database.ref('games/' + gameId).update({ gameState: 'welcome' });
                    }, 1000);
                }
                handleGameStateChange(game);
            });
        }

        function showJoinGame() {
            document.getElementById('joinGameSection').classList.remove('hidden');
        }

        function joinGame() {
            const code = document.getElementById('gameCodeInput').value.toUpperCase();
            if (!code) return alert('Ingresa un c√≥digo');

            database.ref('games/' + code).once('value').then((snapshot) => {
                if (!snapshot.exists()) return alert('Partida no encontrada');
                
                const game = snapshot.val();
                if (game.player2) return alert('Partida llena');

                gameId = code;
                playerNumber = 2;
                
                database.ref('games/' + gameId).update({ player2: true });
                updatePlayerIndicator();

                database.ref('games/' + gameId).on('value', (snapshot) => {
                    handleGameStateChange(snapshot.val());
                });
            });
        }

        function handleGameStateChange(game) {
            if (!game) return;
            
            if (game.gameState === 'welcome') showWelcome();
            else if (game.gameState === 'article') {
                currentArticle = articles[game.currentArticleIndex];
                hideAll();
                document.getElementById('welcomeScreen').style.display = 'none';
                showArticle();
            }
            else if (game.gameState === 'battle' && (game.player1Finished && game.player2Finished)) {
                hideAll();
                document.getElementById('battleScreen').style.display = 'block';
                player1Fuel = game.player1Fuel || 0;
                player2Fuel = game.player2Fuel || 0;
                if (game.player1Position !== undefined && game.player2Position !== undefined) {
                    player1Position = game.player1Position || 0;
                    player2Position = game.player2Position || 0;
                    updateRaceVisuals();
                }
            }
        }

        function showWelcome() {
            document.getElementById('lobbyScreen').style.display = 'none';
            document.getElementById('welcomeScreen').style.display = 'block';
            if (playerNumber === 2) {
                document.getElementById('startBtn').classList.add('hidden');
                document.getElementById('waitingForStart').classList.remove('hidden');
            }
        }

        function startGame() {
            if (playerNumber !== 1) return;
            
            // Obtener los art√≠culos ya usados
            database.ref('games/' + gameId + '/usedArticles').once('value').then((snapshot) => {
                const usedArticles = snapshot.val() || [];
                
                // Filtrar art√≠culos disponibles (no usados)
                const availableIndices = [];
                for (let i = 0; i < articles.length; i++) {
                    if (!usedArticles.includes(i)) {
                        availableIndices.push(i);
                    }
                }
                
                // Si no quedan art√≠culos disponibles, reiniciar
                if (availableIndices.length === 0) {
                    alert('¬°Se han usado todos los art√≠culos! Reiniciando...');
                    database.ref('games/' + gameId).update({ 
                        usedArticles: [],
                        player1Position: 0,
                        player2Position: 0
                    });
                    player1Position = 0;
                    player2Position = 0;
                    // Volver a llamar a startGame para seleccionar un art√≠culo
                    setTimeout(() => startGame(), 1000);
                    return;
                }
                
                // Seleccionar un art√≠culo aleatorio de los disponibles
                const randomIndex = Math.floor(Math.random() * availableIndices.length);
                const selectedArticleIndex = availableIndices[randomIndex];
                
                // Agregar el art√≠culo seleccionado a los usados
                const newUsedArticles = [...usedArticles, selectedArticleIndex];
                
                database.ref('games/' + gameId).update({ 
                    gameState: 'article', 
                    currentArticleIndex: selectedArticleIndex,
                    usedArticles: newUsedArticles,
                    player1Finished: false, 
                    player2Finished: false 
                });
            });
        }

        function showArticle() {
            document.getElementById('articleBox').innerHTML = `<h3>${currentArticle.title}</h3><p style="white-space: pre-line;">${currentArticle.text}</p>`;
            document.getElementById('articleScreen').style.display = 'block';
            let tl = 30;
            document.getElementById('timeLeft').textContent = tl;
            if (articleInterval) clearInterval(articleInterval);
            articleInterval = setInterval(() => {
                tl--;
                document.getElementById('timeLeft').textContent = tl;
                if (tl <= 0) {
                    clearInterval(articleInterval);
                    startQuiz();
                }
            }, 1000);
        }

        function startQuiz() {
            hideAll();
            document.getElementById('quizScreen').style.display = 'block';
            currentQuestion = 0;
            player1Fuel = 0;
            player2Fuel = 0;
            showQuestion();
        }

        function showQuestion() {
            const q = currentArticle.questions[currentQuestion];
            document.getElementById('currentPlayerName').textContent = `T√∫ (J${playerNumber})`;
            document.getElementById('questionText').textContent = q.q;
            const cont = document.getElementById('optionsContainer');
            cont.innerHTML = '';
            
            // Crear array con opciones y sus √≠ndices originales
            const shuffledOptions = q.options.map((o, i) => ({text: o, originalIndex: i}));
            
            // Mezclar aleatoriamente (algoritmo Fisher-Yates)
            for (let i = shuffledOptions.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffledOptions[i], shuffledOptions[j]] = [shuffledOptions[j], shuffledOptions[i]];
            }
            
            // Mostrar opciones mezcladas
            shuffledOptions.forEach((option) => {
                const d = document.createElement('div');
                d.className = 'option';
                d.textContent = option.text;
                d.onclick = () => {
                    const opts = document.querySelectorAll('.option');
                    opts.forEach(p => p.style.pointerEvents = 'none');
                    if (option.originalIndex === q.correct) {
                        d.classList.add('correct');
                        if(playerNumber===1) player1Fuel+=20;
                        else player2Fuel+=20;
                    }
                    else {
                        d.classList.add('incorrect');
                        // Marcar la opci√≥n correcta
                        opts.forEach(opt => {
                            if (opt.textContent === q.options[q.correct]) {
                                opt.classList.add('correct');
                            }
                        });
                    }
                    document.getElementById('fuelText').textContent = (playerNumber===1?player1Fuel:player2Fuel) + "m";
                    document.getElementById('fuelFill').style.width = ((playerNumber===1?player1Fuel:player2Fuel)) + "%";
                    document.getElementById('nextBtn').style.display = 'block';
                };
                cont.appendChild(d);
            });
            document.getElementById('nextBtn').style.display = 'none';
        }

        function nextQuestion() {
            currentQuestion++;
            if (currentQuestion < 5) showQuestion();
            else {
                hideAll();
                document.getElementById('waitingScreen').style.display = 'block';
                document.getElementById('myScore').textContent = playerNumber===1?player1Fuel:player2Fuel;
                const up = {};
                up[`player${playerNumber}Finished`] = true;
                up[`player${playerNumber}Fuel`] = playerNumber===1?player1Fuel:player2Fuel;
                database.ref('games/' + gameId).update(up);
            }
        }

        function updateRaceVisuals() {
            const track = document.getElementById('racetrack').offsetWidth - 150;
            document.getElementById('raceTitle').textContent = `Resultados Etapa`;
            
            // Reproducir sonido de correr
            playRunningSound();
            
            // Animaci√≥n
            document.getElementById('horse1').classList.add('moving');
            document.getElementById('horse2').classList.add('moving');
            
            player1Position += player1Fuel;
            player2Position += player2Fuel;
            
            setTimeout(() => {
                document.getElementById('horse1').style.left = (60 + (player1Position/900 * track)) + 'px';
                document.getElementById('horse2').style.left = (60 + (player2Position/900 * track)) + 'px';
                document.getElementById('distance1').textContent = player1Position + 'm';
                document.getElementById('distance2').textContent = player2Position + 'm';
                document.getElementById('progress1').style.width = (player1Position/900 * 100) + '%';
                document.getElementById('progress2').style.width = (player2Position/900 * 100) + '%';
                document.getElementById('progressText1').textContent = player1Position + 'm';
                document.getElementById('progressText2').textContent = player2Position + 'm';
                
                document.getElementById('horse1').classList.remove('moving');
                document.getElementById('horse2').classList.remove('moving');

                if (player1Position >= 900 || player2Position >= 900) {
                    // Reproducir sonido de victoria
                    playVictorySound();
                    hideAll();
                    document.getElementById('winnerScreen').style.display = 'block';
                    document.getElementById('winnerText').textContent = player1Position > player2Position ? "¬°Gana Jugador 1!" : "¬°Gana Jugador 2!";
                }
            }, 500);

            if (playerNumber === 1) database.ref('games/' + gameId).update({ player1Position, player2Position, player1Fuel:0, player2Fuel:0 });
        }

        function continueRace() {
            if (playerNumber === 1) startGame();
        }

        function updatePlayerIndicator() {
            const indicator = document.getElementById('playerIndicator');
            indicator.textContent = `Yo soy el Jugador ${playerNumber}`;
            indicator.style.display = 'block';
        }

        function playRunningSound() {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const duration = 1.5;
            
            for (let i = 0; i < 8; i++) {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = 100 + Math.random() * 50;
                oscillator.type = 'sine';
                
                const startTime = audioContext.currentTime + (i * 0.15);
                gainNode.gain.setValueAtTime(0.3, startTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, startTime + 0.1);
                
                oscillator.start(startTime);
                oscillator.stop(startTime + 0.1);
            }
        }

        function playVictorySound() {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            
            const notes = [262, 330, 392, 523];
            
            notes.forEach((freq, index) => {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = freq;
                oscillator.type = 'triangle';
                
                const startTime = audioContext.currentTime + (index * 0.2);
                gainNode.gain.setValueAtTime(0.3, startTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, startTime + 0.4);
                
                oscillator.start(startTime);
                oscillator.stop(startTime + 0.4);
            });
            
            setTimeout(() => {
                [523, 659, 784].forEach(freq => {
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.frequency.value = freq;
                    oscillator.type = 'triangle';
                    
                    gainNode.gain.setValueAtTime(0.4, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 1);
                    
                    oscillator.start();
                    oscillator.stop(audioContext.currentTime + 1);
                });
            }, 800);
        }

        function hideAll() {
            ['lobbyScreen','welcomeScreen','articleScreen','quizScreen','waitingScreen','battleScreen','winnerScreen'].forEach(id => {
                document.getElementById(id).style.display = 'none';
            });
        }
    </script>
</body>
</html>
