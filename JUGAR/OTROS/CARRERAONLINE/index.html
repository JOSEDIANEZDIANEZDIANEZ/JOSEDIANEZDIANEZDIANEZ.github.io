<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Batalla Constitucional Online - T√≠tulo Preliminar</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow-x: hidden;
        }

        .container {
            max-width: 900px;
            width: 95%;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            padding: 30px;
            text-align: center;
            color: white;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.95;
        }

        .player-indicator {
            background: rgba(255, 255, 255, 0.2);
            padding: 10px 25px;
            border-radius: 25px;
            font-size: 1.2em;
            font-weight: bold;
            margin-top: 15px;
            display: none;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .content {
            padding: 40px;
        }

        /* Pantalla de lobby */
        .lobby-screen {
            text-align: center;
        }

        .lobby-screen h2 {
            color: #667eea;
            font-size: 2em;
            margin-bottom: 20px;
        }

        .lobby-screen p {
            color: #666;
            font-size: 1.1em;
            line-height: 1.8;
            margin-bottom: 30px;
        }

        .lobby-options {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-bottom: 30px;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.2em;
            border-radius: 50px;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);
        }

        .input-group {
            margin: 20px 0;
        }

        .input-group input {
            padding: 15px 20px;
            font-size: 1.2em;
            border: 2px solid #ddd;
            border-radius: 10px;
            width: 300px;
            text-align: center;
            text-transform: uppercase;
        }

        .input-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .game-code {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .game-code h3 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .game-code .code {
            font-size: 3em;
            font-weight: bold;
            color: #f5576c;
            letter-spacing: 10px;
            font-family: 'Courier New', monospace;
        }

        .waiting-message {
            color: #666;
            font-size: 1.2em;
            margin: 20px 0;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .players-status {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .player-slot {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            margin: 5px 0;
            background: white;
            border-radius: 5px;
        }

        .player-slot.ready {
            background: #84fab0;
        }

        /* Pantalla de bienvenida */
        .welcome-screen {
            text-align: center;
            display: none;
        }

        .welcome-screen h2 {
            color: #667eea;
            font-size: 2em;
            margin-bottom: 20px;
        }

        .welcome-screen p {
            color: #666;
            font-size: 1.1em;
            line-height: 1.8;
            margin-bottom: 30px;
        }

        /* Pantalla de art√≠culo */
        .article-screen {
            display: none;
        }

        .article-box {
            background: #f8f9fa;
            border-left: 5px solid #667eea;
            padding: 25px;
            margin-bottom: 30px;
            border-radius: 10px;
        }

        .article-box h3 {
            color: #667eea;
            font-size: 1.8em;
            margin-bottom: 15px;
        }

        .article-box p {
            color: #444;
            font-size: 1.1em;
            line-height: 1.8;
        }

        .timer {
            text-align: center;
            margin: 30px 0;
        }

        .timer h3 {
            color: #f5576c;
            font-size: 3em;
            margin-bottom: 10px;
        }

        .timer p {
            color: #666;
            font-size: 1.2em;
        }

        /* Pantalla de quiz */
        .quiz-screen {
            display: none;
        }

        .current-player {
            background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 20px;
        }

        .current-player h3 {
            color: white;
            font-size: 1.5em;
        }

        .question-box {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .question-box h3 {
            color: #667eea;
            font-size: 1.5em;
            margin-bottom: 20px;
            text-align: center;
        }

        .options-container {
            display: grid;
            gap: 15px;
        }

        .option {
            background: white;
            border: 3px solid #ddd;
            padding: 20px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1.1em;
        }

        .option:hover {
            border-color: #667eea;
            transform: translateX(5px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.2);
        }

        .option.correct {
            background: #84fab0;
            border-color: #5cb85c;
            animation: correctAnswer 0.5s;
        }

        .option.incorrect {
            background: #ffb3b3;
            border-color: #d9534f;
            animation: shake 0.5s;
        }

        @keyframes correctAnswer {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        .fuel-indicator {
            margin-top: 30px;
            text-align: center;
        }

        .fuel-bar {
            background: #ddd;
            height: 40px;
            border-radius: 20px;
            overflow: hidden;
            margin: 10px 0;
        }

        .fuel-fill {
            background: linear-gradient(90deg, #84fab0 0%, #8fd3f4 100%);
            height: 100%;
            width: 0%;
            transition: width 0.5s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .next-btn {
            display: none;
            margin-top: 20px;
        }

        /* Pantalla de espera */
        .waiting-screen {
            display: none;
            text-align: center;
        }

        .waiting-screen h2 {
            color: #667eea;
            font-size: 2em;
            margin-bottom: 20px;
        }

        .score-display {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .score-display h3 {
            color: #667eea;
            font-size: 2.5em;
        }

        /* Pantalla de batalla */
        .battle-screen {
            display: none;
        }

        .race-title {
            text-align: center;
            color: #667eea;
            font-size: 2em;
            margin-bottom: 30px;
        }

        .racetrack {
            background: #e8f5e9;
            border: 3px solid #4caf50;
            border-radius: 15px;
            padding: 40px 20px;
            position: relative;
            margin-bottom: 30px;
            min-height: 200px;
        }

        .lane {
            background: linear-gradient(to right, #fff3e0 0%, #fff3e0 100%);
            border: 2px dashed #ff9800;
            height: 60px;
            margin: 20px 0;
            border-radius: 10px;
            position: relative;
        }

        .horse {
            position: absolute;
            left: 60px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 3em;
            transition: left 2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .horse.moving {
            animation: gallop 0.3s steps(2) infinite;
        }

        @keyframes gallop {
            0%, 100% { transform: translateY(-50%) rotate(-5deg); }
            50% { transform: translateY(-50%) rotate(5deg); }
        }

        .player-label {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            font-weight: bold;
            color: #667eea;
        }

        .distance {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            color: #f5576c;
        }

        .finish-line {
            position: absolute;
            right: 20px;
            top: 0;
            bottom: 0;
            width: 5px;
            background: repeating-linear-gradient(
                45deg,
                #000,
                #000 10px,
                #fff 10px,
                #fff 20px
            );
        }

        .progress-bars {
            margin-top: 30px;
        }

        .progress-item {
            margin: 20px 0;
        }

        .progress-item h4 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .progress-bar {
            background: #ddd;
            height: 30px;
            border-radius: 15px;
            overflow: hidden;
            position: relative;
        }

        .progress {
            background: linear-gradient(90deg, #84fab0 0%, #8fd3f4 100%);
            height: 100%;
            width: 0%;
            transition: width 2s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 10px;
            color: white;
            font-weight: bold;
        }

        .continue-btn {
            margin-top: 30px;
        }

        /* Pantalla de ganador */
        .winner-screen {
            display: none;
            text-align: center;
        }

        .winner-screen h2 {
            color: #f5576c;
            font-size: 3em;
            margin-bottom: 20px;
            animation: bounce 1s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }

        .trophy {
            font-size: 10em;
            margin: 30px 0;
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>‚öîÔ∏è Batalla Constitucional Online ‚öîÔ∏è</h1>
            <p>T√≠tulo Preliminar - De los espa√±oles y los extranjeros</p>
            <div id="playerIndicator" class="player-indicator"></div>
        </div>

        <div class="content">
            <!-- Pantalla de Lobby -->
            <div id="lobbyScreen" class="lobby-screen">
                <h2>üéÆ Bienvenido al Lobby</h2>
                <p>Selecciona una opci√≥n para comenzar:</p>
                
                <div class="lobby-options">
                    <button class="btn" onclick="createGame()">Crear Partida</button>
                    <button class="btn btn-secondary" onclick="showJoinGame()">Unirse a Partida</button>
                </div>

                <div id="createGameSection" class="hidden">
                    <div class="game-code">
                        <h3>C√≥digo de Partida</h3>
                        <div class="code" id="gameCode">----</div>
                    </div>
                    <div class="players-status">
                        <div class="player-slot ready">
                            <span>üë§</span>
                            <span>Jugador 1: Listo</span>
                        </div>
                        <div class="player-slot" id="player2Slot">
                            <span>‚è≥</span>
                            <span>Esperando Jugador 2...</span>
                        </div>
                    </div>
                </div>

                <div id="joinGameSection" class="hidden">
                    <div class="input-group">
                        <input type="text" id="joinCodeInput" placeholder="C√ìDIGO" maxlength="4">
                    </div>
                    <button class="btn" onclick="joinGame()">Unirse</button>
                </div>
            </div>

            <!-- Pantalla de Bienvenida -->
            <div id="welcomeScreen" class="welcome-screen">
                <h2>üéØ Preparados para la Batalla</h2>
                <p>Van a aparecer art√≠culos de la Constituci√≥n.<br>
                   Tienes 30 segundos para leerlo.<br>
                   Luego responder√°s 5 preguntas.<br>
                   Cada respuesta correcta te da 20 metros.<br>
                   ¬°El primero en llegar a 900m gana!</p>
                
                <button class="btn" id="startBtn" onclick="startGame()">¬°Comenzar!</button>
                <p class="waiting-message hidden" id="waitingForStart">Esperando que el Jugador 1 inicie...</p>
            </div>

            <!-- Pantalla de Art√≠culo -->
            <div id="articleScreen" class="article-screen">
                <div id="articleBox" class="article-box"></div>
                <div class="timer">
                    <h3 id="timeLeft">30</h3>
                    <p>segundos para leer</p>
                </div>
            </div>

            <!-- Pantalla de Quiz -->
            <div id="quizScreen" class="quiz-screen">
                <div class="current-player">
                    <h3>Turno de: <span id="currentPlayerName"></span></h3>
                </div>
                
                <div class="question-box">
                    <h3 id="questionText"></h3>
                    <div id="optionsContainer" class="options-container"></div>
                </div>

                <div class="fuel-indicator">
                    <p>Combustible acumulado:</p>
                    <div class="fuel-bar">
                        <div id="fuelFill" class="fuel-fill">
                            <span id="fuelText">0m</span>
                        </div>
                    </div>
                </div>

                <button class="btn next-btn" id="nextBtn" onclick="nextQuestion()">Siguiente Pregunta ‚Üí</button>
            </div>

            <!-- Pantalla de Espera -->
            <div id="waitingScreen" class="waiting-screen">
                <h2>‚è≥ Esperando al otro jugador...</h2>
                <div class="score-display">
                    <p>Tu puntuaci√≥n:</p>
                    <h3><span id="myScore">0</span>m</h3>
                </div>
                <p class="waiting-message">El otro jugador est√° respondiendo las preguntas...</p>
            </div>

            <!-- Pantalla de Batalla -->
            <div id="battleScreen" class="battle-screen">
                <h2 id="raceTitle" class="race-title">Resultados Etapa</h2>
                
                <div id="racetrack" class="racetrack">
                    <div class="finish-line"></div>
                    
                    <div class="lane">
                        <div class="player-label">J1</div>
                        <div id="horse1" class="horse">üèÉ</div>
                        <div id="distance1" class="distance">0m</div>
                    </div>
                    
                    <div class="lane">
                        <div class="player-label">J2</div>
                        <div id="horse2" class="horse">üèÉ</div>
                        <div id="distance2" class="distance">0m</div>
                    </div>
                </div>

                <div class="progress-bars">
                    <div class="progress-item">
                        <h4>Jugador 1</h4>
                        <div class="progress-bar">
                            <div id="progress1" class="progress">
                                <span id="progressText1">0m</span>
                            </div>
                        </div>
                    </div>
                    <div class="progress-item">
                        <h4>Jugador 2</h4>
                        <div class="progress-bar">
                            <div id="progress2" class="progress">
                                <span id="progressText2">0m</span>
                            </div>
                        </div>
                    </div>
                </div>

                <button class="btn continue-btn" onclick="continueRace()">Continuar Carrera ‚Üí</button>
            </div>

            <!-- Pantalla de Ganador -->
            <div id="winnerScreen" class="winner-screen">
                <h2 id="winnerText">¬°Ganador!</h2>
                <div class="trophy">üèÜ</div>
                <p style="font-size: 1.3em; color: #666;">¬°Felicidades! Has demostrado ser un experto en la Constituci√≥n</p>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDW3unoEx8VIvVXeWr9kUJE92Sc7L3maMw",
            authDomain: "quizappconstitucional.firebaseapp.com",
            databaseURL: "https://quizappconstitucional-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "quizappconstitucional",
            storageBucket: "quizappconstitucional.firebasestorage.app",
            messagingSenderId: "515582919162",
            appId: "1:515582919162:web:e29e44b7c6c8dfd2aecd2f"
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        const articles = [
            {
                title: "Art√≠culo 11",
                text: `1. La nacionalidad espa√±ola se adquiere, se conserva y se pierde de acuerdo con lo establecido por la ley.
2. Ning√∫n espa√±ol de origen podr√° ser privado de su nacionalidad.
3. El Estado podr√° concertar tratados de doble nacionalidad con los pa√≠ses iberoamericanos o con aquellos que hayan tenido o tengan una particular vinculaci√≥n con Espa√±a. En estos mismos pa√≠ses, aun cuando no reconozcan a sus ciudadanos un derecho rec√≠proco, podr√°n naturalizarse los espa√±oles sin perder su nacionalidad de origen.`,
                questions: [
                    { q: "¬øQu√© regula el art√≠culo 11?", options: ["La nacionalidad espa√±ola", "Los derechos fundamentales", "El sistema electoral", "La organizaci√≥n territorial"], correct: 0 },
                    { q: "¬øPuede un espa√±ol de origen ser privado de su nacionalidad?", options: ["S√≠, en casos excepcionales", "No, en ning√∫n caso", "S√≠, por decisi√≥n judicial", "Depende de la ley"], correct: 1 },
                    { q: "¬øCon qu√© pa√≠ses puede Espa√±a concertar tratados de doble nacionalidad?", options: ["Solo con pa√≠ses de la UE", "Con pa√≠ses iberoamericanos y los que tengan vinculaci√≥n especial", "Con todos los pa√≠ses del mundo", "Solo con Portugal"], correct: 1 },
                    { q: "¬øPueden los espa√±oles naturalizarse en pa√≠ses iberoamericanos sin perder la nacionalidad espa√±ola?", options: ["No, siempre la pierden", "S√≠, incluso si no hay reciprocidad", "Solo si hay reciprocidad", "Depende del pa√≠s"], correct: 1 },
                    { q: "¬øQui√©n determina c√≥mo se adquiere y pierde la nacionalidad espa√±ola?", options: ["La Constituci√≥n directamente", "La ley", "El Gobierno", "Los tratados internacionales"], correct: 1 }
                ]
            },
            {
                title: "Art√≠culo 12",
                text: `Los espa√±oles son mayores de edad a los dieciocho a√±os.`,
                questions: [
                    { q: "¬øA qu√© edad se alcanza la mayor√≠a de edad en Espa√±a?", options: ["16 a√±os", "18 a√±os", "21 a√±os", "17 a√±os"], correct: 1 },
                    { q: "¬øQu√© establece el art√≠culo 12?", options: ["Los derechos de los menores", "La edad de jubilaci√≥n", "La mayor√≠a de edad", "La edad para votar"], correct: 2 },
                    { q: "¬øEs la mayor√≠a de edad igual para todos los espa√±oles?", options: ["S√≠, a los 18 a√±os", "No, depende de la comunidad aut√≥noma", "No, depende del sexo", "Depende de la nacionalidad"], correct: 0 },
                    { q: "Antes de los 18 a√±os, ¬øse es mayor de edad?", options: ["S√≠", "No", "Depende", "Solo para ciertos actos"], correct: 1 },
                    { q: "¬øPuede una ley ordinaria cambiar la edad de mayor√≠a de edad?", options: ["S√≠, libremente", "No, est√° en la Constituci√≥n", "Solo con reforma constitucional", "Depende del Gobierno"], correct: 1 }
                ]
            },
            {
                title: "Art√≠culo 13.1",
                text: `1. Los extranjeros gozar√°n en Espa√±a de las libertades p√∫blicas que garantiza el presente T√≠tulo en los t√©rminos que establezcan los tratados y la ley.`,
                questions: [
                    { q: "¬øPueden los extranjeros disfrutar de libertades p√∫blicas en Espa√±a?", options: ["No, son solo para espa√±oles", "S√≠, seg√∫n tratados y la ley", "S√≠, sin restricciones", "Solo en casos excepcionales"], correct: 1 },
                    { q: "¬øQu√© determina los t√©rminos en que los extranjeros gozan de libertades p√∫blicas?", options: ["Solo la Constituci√≥n", "Los tratados y la ley", "El Gobierno", "Solo los tratados"], correct: 1 },
                    { q: "¬øTiene el art√≠culo 13.1 el mismo alcance para espa√±oles y extranjeros?", options: ["S√≠, exactamente igual", "No, los extranjeros tienen condiciones especiales", "Solo en algunos derechos", "Depende del pa√≠s de origen"], correct: 1 },
                    { q: "¬øQu√© t√≠tulo de la Constituci√≥n garantiza las libertades p√∫blicas?", options: ["El T√≠tulo Preliminar", "El T√≠tulo I", "El T√≠tulo II", "El T√≠tulo III"], correct: 0 },
                    { q: "¬øPueden los tratados internacionales limitar las libertades de los extranjeros?", options: ["No, nunca", "S√≠, junto con la ley", "Solo la ley puede", "Solo en guerra"], correct: 1 }
                ]
            },
            {
                title: "Art√≠culo 13.2",
                text: `2. Solamente los espa√±oles ser√°n titulares de los derechos reconocidos en el art√≠culo 23, salvo lo que, atendiendo a criterios de reciprocidad, pueda establecerse por tratado o ley para el derecho de sufragio activo y pasivo en las elecciones municipales.`,
                questions: [
                    { q: "¬øQu√© art√≠culo reconoce los derechos pol√≠ticos?", options: ["Art√≠culo 14", "Art√≠culo 23", "Art√≠culo 13", "Art√≠culo 11"], correct: 1 },
                    { q: "¬øPueden los extranjeros votar en elecciones municipales?", options: ["No, nunca", "S√≠, sin restricciones", "S√≠, si hay reciprocidad", "Solo los de la UE"], correct: 2 },
                    { q: "¬øQui√©nes son titulares de los derechos del art√≠culo 23?", options: ["Todos los residentes", "Solo los espa√±oles", "Los ciudadanos de la UE", "Todos los mayores de edad"], correct: 1 },
                    { q: "¬øQu√© significa 'sufragio pasivo'?", options: ["El derecho a votar", "El derecho a ser elegido", "El derecho a un juicio justo", "El derecho de reuni√≥n"], correct: 1 },
                    { q: "¬øPuede un tratado permitir que extranjeros voten en elecciones municipales?", options: ["No, est√° prohibido", "S√≠, si hay reciprocidad", "Solo en la UE", "Depende del Gobierno"], correct: 1 }
                ]
            },
            {
                title: "Art√≠culo 13.3",
                text: `3. La extradici√≥n s√≥lo se conceder√° en cumplimiento de un tratado o de la ley, atendiendo al principio de reciprocidad. Quedan excluidos de la extradici√≥n los delitos pol√≠ticos, no consider√°ndose como tales los actos de terrorismo.`,
                questions: [
                    { q: "¬øCu√°ndo se puede conceder la extradici√≥n?", options: ["Por decisi√≥n del Gobierno", "Seg√∫n tratado o ley", "En cualquier momento", "Solo con pa√≠ses de la UE"], correct: 1 },
                    { q: "¬øSe pueden extraditar personas por delitos pol√≠ticos?", options: ["S√≠, siempre", "No, est√°n excluidos", "Depende del pa√≠s", "Solo en casos graves"], correct: 1 },
                    { q: "¬øSon los actos de terrorismo considerados delitos pol√≠ticos?", options: ["S√≠", "No", "Depende del caso", "Solo si son internacionales"], correct: 1 },
                    { q: "¬øQu√© principio se debe atender en la extradici√≥n?", options: ["De legalidad", "De reciprocidad", "De igualdad", "De proporcionalidad"], correct: 1 },
                    { q: "¬øPuede Espa√±a extraditar sin tratado?", options: ["No, debe haber tratado o ley", "S√≠, libremente", "Solo con pa√≠ses vecinos", "Depende del delito"], correct: 0 }
                ]
            },
            {
                title: "Art√≠culo 13.4",
                text: `4. La ley establecer√° los t√©rminos en que los ciudadanos de otros pa√≠ses y los ap√°tridas podr√°n gozar del derecho de asilo en Espa√±a.`,
                questions: [
                    { q: "¬øQui√©n establece los t√©rminos del derecho de asilo?", options: ["La Constituci√≥n", "La ley", "El Gobierno", "Los tratados"], correct: 1 },
                    { q: "¬øPueden los ap√°tridas solicitar asilo en Espa√±a?", options: ["No", "S√≠", "Solo en guerra", "Depende de su origen"], correct: 1 },
                    { q: "¬øQu√© es un ap√°trida?", options: ["Persona sin nacionalidad", "Refugiado pol√≠tico", "Inmigrante ilegal", "Ciudadano de la UE"], correct: 0 },
                    { q: "¬øEst√° el derecho de asilo regulado directamente en la Constituci√≥n?", options: ["S√≠, completamente", "No, se remite a la ley", "Solo para europeos", "Depende del caso"], correct: 1 },
                    { q: "¬øPueden los ciudadanos de otros pa√≠ses gozar del derecho de asilo?", options: ["No, solo ap√°tridas", "S√≠, seg√∫n la ley", "Solo de pa√≠ses en guerra", "Depende del tratado"], correct: 1 }
                ]
            }
        ];

        let gameId = null;
        let playerNumber = null;
        let currentArticle = null;
        let currentQuestion = 0;
        let player1Fuel = 0;
        let player2Fuel = 0;
        let player1Position = 0;
        let player2Position = 0;
        let articleInterval = null;

        function createGame() {
            gameId = Math.random().toString(36).substr(2, 4).toUpperCase();
            playerNumber = 1;
            
            database.ref('games/' + gameId).set({
                player1: true,
                player2: false,
                gameState: 'lobby'
            });

            document.getElementById('gameCode').textContent = gameId;
            document.getElementById('createGameSection').classList.remove('hidden');
            updatePlayerIndicator();
            listenForGameChanges();
        }

        function showJoinGame() {
            document.getElementById('joinGameSection').classList.remove('hidden');
        }

        function joinGame() {
            gameId = document.getElementById('joinCodeInput').value.toUpperCase();
            if (!gameId) return;
            
            database.ref('games/' + gameId).once('value').then(snapshot => {
                if (!snapshot.exists()) {
                    alert('C√≥digo de partida no v√°lido');
                    return;
                }
                
                playerNumber = 2;
                database.ref('games/' + gameId).update({ player2: true });
                updatePlayerIndicator();
                listenForGameChanges();
            });
        }

        function listenForGameChanges() {
            database.ref('games/' + gameId).on('value', snapshot => {
                const game = snapshot.val();
                if (!game) return;

                if (game.player2 && game.gameState === 'lobby') {
                    document.getElementById('player2Slot').innerHTML = '<span>‚úÖ</span><span>Jugador 2: Listo</span>';
                    document.getElementById('player2Slot').classList.add('ready');
                    setTimeout(() => {
                        database.ref('games/' + gameId).update({ gameState: 'welcome' });
                    }, 1000);
                }

                if (game.gameState === 'welcome') {
                    showWelcome();
                }

                if (game.gameState === 'article' && game.currentArticleIndex !== undefined) {
                    currentArticle = articles[game.currentArticleIndex];
                    hideAll();
                    showArticle();
                }

                if (game.player1Finished && game.player2Finished) {
                    hideAll();
                    document.getElementById('battleScreen').style.display = 'block';
                    player1Fuel = game.player1Fuel || 0;
                    player2Fuel = game.player2Fuel || 0;
                    player1Position = game.player1Position || 0; player2Position = game.player2Position || 0;
                    updateRaceVisuals();
                }
            });
        }

        function showWelcome() {
            document.getElementById('lobbyScreen').style.display = 'none';
            document.getElementById('welcomeScreen').style.display = 'block';
            if (playerNumber === 2) {
                document.getElementById('startBtn').classList.add('hidden');
                document.getElementById('waitingForStart').classList.remove('hidden');
            }
        }

        function startGame() {
            if (playerNumber !== 1) return;
            
            // Obtener art√≠culos usados de la base de datos
            database.ref('games/' + gameId).once('value').then(snapshot => {
                const gameData = snapshot.val();
                const usedArticles = gameData.usedArticles || [];
                
                // Crear array de √≠ndices disponibles (art√≠culos no usados)
                const availableIndices = [];
                for (let i = 0; i < articles.length; i++) {
                    if (!usedArticles.includes(i)) {
                        availableIndices.push(i);
                    }
                }
                
                // Si no quedan art√≠culos disponibles, reiniciar el array de usados
                if (availableIndices.length === 0) {
                    database.ref('games/' + gameId).update({ 
                        usedArticles: [],
                        currentArticleIndex: 0,
                        gameState: 'article',
                        player1Finished: false,
                        player2Finished: false
                    });
                    return;
                }
                
                // Seleccionar un art√≠culo aleatorio de los disponibles
                const randomIndex = Math.floor(Math.random() * availableIndices.length);
                const selectedArticleIndex = availableIndices[randomIndex];
                
                // Agregar el art√≠culo seleccionado a los usados
                const newUsedArticles = [...usedArticles, selectedArticleIndex];
                
                // Actualizar base de datos
                database.ref('games/' + gameId).update({ 
                    gameState: 'article', 
                    currentArticleIndex: selectedArticleIndex,
                    usedArticles: newUsedArticles,
                    player1Finished: false, 
                    player2Finished: false 
                });
            });
        }

        function showArticle() {
            document.getElementById('articleBox').innerHTML = `<h3>${currentArticle.title}</h3><p style="white-space: pre-line;">${currentArticle.text}</p>`;
            document.getElementById('articleScreen').style.display = 'block';
            let tl = 30; document.getElementById('timeLeft').textContent = tl;
            if (articleInterval) clearInterval(articleInterval);
            articleInterval = setInterval(() => {
                tl--; document.getElementById('timeLeft').textContent = tl;
                if (tl <= 0) { clearInterval(articleInterval); startQuiz(); }
            }, 1000);
        }

        function startQuiz() {
            hideAll();
            document.getElementById('quizScreen').style.display = 'block';
            currentQuestion = 0; player1Fuel = 0; player2Fuel = 0;
            showQuestion();
        }

        function showQuestion() {
            const q = currentArticle.questions[currentQuestion];
            document.getElementById('currentPlayerName').textContent = `T√∫ (J${playerNumber})`;
            document.getElementById('questionText').textContent = q.q;
            const cont = document.getElementById('optionsContainer'); cont.innerHTML = '';
            
            // Crear array con opciones y sus √≠ndices originales
            const shuffledOptions = q.options.map((o, i) => ({text: o, originalIndex: i}));
            
            // Mezclar aleatoriamente (algoritmo Fisher-Yates)
            for (let i = shuffledOptions.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffledOptions[i], shuffledOptions[j]] = [shuffledOptions[j], shuffledOptions[i]];
            }
            
            // Mostrar opciones mezcladas
            shuffledOptions.forEach((option) => {
                const d = document.createElement('div'); d.className = 'option'; d.textContent = option.text;
                d.onclick = () => {
                    const opts = document.querySelectorAll('.option');
                    opts.forEach(p => p.style.pointerEvents = 'none');
                    if (option.originalIndex === q.correct) { 
                        d.classList.add('correct'); 
                        if(playerNumber===1) player1Fuel+=20; else player2Fuel+=20; 
                    }
                    else { 
                        d.classList.add('incorrect'); 
                        // Marcar la opci√≥n correcta
                        opts.forEach(opt => {
                            if (opt.textContent === q.options[q.correct]) {
                                opt.classList.add('correct');
                            }
                        });
                    }
                    document.getElementById('fuelText').textContent = (playerNumber===1?player1Fuel:player2Fuel) + "m";
                    document.getElementById('fuelFill').style.width = ((playerNumber===1?player1Fuel:player2Fuel)) + "%";
                    document.getElementById('nextBtn').style.display = 'block';
                };
                cont.appendChild(d);
            });
            document.getElementById('nextBtn').style.display = 'none';
        }

        function nextQuestion() {
            currentQuestion++;
            if (currentQuestion < 5) showQuestion();
            else {
                hideAll(); document.getElementById('waitingScreen').style.display = 'block';
                document.getElementById('myScore').textContent = playerNumber===1?player1Fuel:player2Fuel;
                const up = {}; up[`player${playerNumber}Finished`] = true; up[`player${playerNumber}Fuel`] = playerNumber===1?player1Fuel:player2Fuel;
                database.ref('games/' + gameId).update(up);
            }
        }

        function updateRaceVisuals() {
            const track = document.getElementById('racetrack').offsetWidth - 150;
            document.getElementById('raceTitle').textContent = `Resultados Etapa`;
            
            // Reproducir sonido de correr
            playRunningSound();
            
            // Animaci√≥n
            document.getElementById('horse1').classList.add('moving');
            document.getElementById('horse2').classList.add('moving');
            
            player1Position += player1Fuel; player2Position += player2Fuel;
            
            setTimeout(() => {
                document.getElementById('horse1').style.left = (60 + (player1Position/900 * track)) + 'px';
                document.getElementById('horse2').style.left = (60 + (player2Position/900 * track)) + 'px';
                document.getElementById('distance1').textContent = player1Position + 'm';
                document.getElementById('distance2').textContent = player2Position + 'm';
                document.getElementById('progress1').style.width = (player1Position/900 * 100) + '%';
                document.getElementById('progress2').style.width = (player2Position/900 * 100) + '%';
                document.getElementById('progressText1').textContent = player1Position + 'm';
                document.getElementById('progressText2').textContent = player2Position + 'm';
                
                document.getElementById('horse1').classList.remove('moving');
                document.getElementById('horse2').classList.remove('moving');

                if (player1Position >= 900 || player2Position >= 900) {
                    // Reproducir sonido de victoria
                    playVictorySound();
                    hideAll(); document.getElementById('winnerScreen').style.display = 'block';
                    document.getElementById('winnerText').textContent = player1Position > player2Position ? "¬°Gana Jugador 1!" : "¬°Gana Jugador 2!";
                }
            }, 500);

            if (playerNumber === 1) database.ref('games/' + gameId).update({ player1Position, player2Position, player1Fuel:0, player2Fuel:0 });
        }

        function continueRace() {
            if (playerNumber === 1) startGame();
        }

        function updatePlayerIndicator() {
            const indicator = document.getElementById('playerIndicator');
            indicator.textContent = `Yo soy el Jugador ${playerNumber}`;
            indicator.style.display = 'block';
        }

        function playRunningSound() {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const duration = 1.5; // Duraci√≥n del sonido de correr
            
            // Crear varios pasos r√°pidos
            for (let i = 0; i < 8; i++) {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = 100 + Math.random() * 50; // Frecuencia baja para simular pasos
                oscillator.type = 'sine';
                
                const startTime = audioContext.currentTime + (i * 0.15);
                gainNode.gain.setValueAtTime(0.3, startTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, startTime + 0.1);
                
                oscillator.start(startTime);
                oscillator.stop(startTime + 0.1);
            }
        }

        function playVictorySound() {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            
            // Melod√≠a de victoria ascendente
            const notes = [262, 330, 392, 523]; // Do, Mi, Sol, Do (octava alta)
            
            notes.forEach((freq, index) => {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = freq;
                oscillator.type = 'triangle';
                
                const startTime = audioContext.currentTime + (index * 0.2);
                gainNode.gain.setValueAtTime(0.3, startTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, startTime + 0.4);
                
                oscillator.start(startTime);
                oscillator.stop(startTime + 0.4);
            });
            
            // Agregar un acorde final triunfal
            setTimeout(() => {
                [523, 659, 784].forEach(freq => { // Do, Mi, Sol (octava alta)
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.frequency.value = freq;
                    oscillator.type = 'triangle';
                    
                    gainNode.gain.setValueAtTime(0.4, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 1);
                    
                    oscillator.start();
                    oscillator.stop(audioContext.currentTime + 1);
                });
            }, 800);
        }

        function hideAll() {
            ['lobbyScreen','welcomeScreen','articleScreen','quizScreen','waitingScreen','battleScreen','winnerScreen'].forEach(id => {
                document.getElementById(id).style.display = 'none';
            });
        }
    </script>
</body>
</html>
