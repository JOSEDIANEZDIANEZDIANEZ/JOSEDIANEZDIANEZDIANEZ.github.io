<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Batalla Constitucional Online - T√≠tulo Preliminar</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow-x: hidden;
        }

        .container {
            max-width: 900px;
            width: 95%;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            padding: 30px;
            text-align: center;
            color: white;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.95;
        }

        .content {
            padding: 40px;
        }

        /* Pantalla de lobby */
        .lobby-screen {
            text-align: center;
        }

        .lobby-screen h2 {
            color: #667eea;
            font-size: 2em;
            margin-bottom: 20px;
        }

        .lobby-screen p {
            color: #666;
            font-size: 1.1em;
            line-height: 1.8;
            margin-bottom: 30px;
        }

        .lobby-options {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-bottom: 30px;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.2em;
            border-radius: 50px;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);
        }

        .input-group {
            margin: 20px 0;
        }

        .input-group input {
            padding: 15px 20px;
            font-size: 1.2em;
            border: 2px solid #ddd;
            border-radius: 10px;
            width: 300px;
            text-align: center;
            text-transform: uppercase;
        }

        .input-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .game-code {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .game-code h3 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .game-code .code {
            font-size: 3em;
            font-weight: bold;
            color: #f5576c;
            letter-spacing: 10px;
            font-family: 'Courier New', monospace;
        }

        .waiting-message {
            color: #666;
            font-size: 1.2em;
            margin: 20px 0;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .players-status {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .player-slot {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            margin: 5px 0;
            background: white;
            border-radius: 5px;
        }

        .player-slot.ready {
            background: #84fab0;
        }

        /* Pantalla de bienvenida */
        .welcome-screen {
            text-align: center;
            display: none;
        }

        .welcome-screen h2 {
            color: #667eea;
            font-size: 2em;
            margin-bottom: 20px;
        }

        .welcome-screen p {
            color: #666;
            font-size: 1.1em;
            line-height: 1.8;
            margin-bottom: 30px;
        }

        /* Pantalla de art√≠culo */
        .article-screen {
            display: none;
        }

        .article-box {
            background: #f8f9fa;
            border-left: 5px solid #667eea;
            padding: 25px;
            margin-bottom: 30px;
            border-radius: 10px;
            line-height: 1.8;
        }

        .article-box h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.5em;
        }

        .article-box p {
            color: #333;
            font-size: 1.05em;
        }

        .timer {
            text-align: center;
            font-size: 1.5em;
            color: #f5576c;
            font-weight: bold;
            margin: 20px 0;
        }

        /* Pantalla de preguntas */
        .quiz-screen {
            display: none;
        }

        .player-info {
            background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 25px;
            text-align: center;
        }

        .player-info h3 {
            color: #333;
            font-size: 1.8em;
            margin-bottom: 10px;
        }

        .fuel-bar {
            background: white;
            height: 30px;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.1);
        }

        .fuel-fill {
            height: 100%;
            background: linear-gradient(90deg, #f093fb 0%, #f5576c 100%);
            transition: width 0.5s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .question-box {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 25px;
        }

        .question-box h4 {
            color: #667eea;
            font-size: 1.3em;
            margin-bottom: 20px;
        }

        .options {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .option {
            background: white;
            border: 2px solid #ddd;
            padding: 15px 20px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1.05em;
        }

        .option:hover {
            border-color: #667eea;
            transform: translateX(5px);
            box-shadow: 0 3px 10px rgba(102, 126, 234, 0.2);
        }

        .option.selected {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .option.correct {
            background: #84fab0;
            border-color: #84fab0;
            animation: pulse-once 0.5s;
        }

        .option.incorrect {
            background: #f5576c;
            color: white;
            border-color: #f5576c;
            animation: shake 0.5s;
        }

        @keyframes pulse-once {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        /* Pantalla de carrera */
        .battle-screen {
            display: none;
        }

        .race-info {
            text-align: center;
            margin-bottom: 20px;
            padding: 15px;
            background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%);
            border-radius: 10px;
        }

        .race-info h3 {
            color: #2d3436;
            font-size: 1.5em;
            margin-bottom: 5px;
        }

        .racetrack {
            background: linear-gradient(to bottom, #87CEEB 0%, #E0F6FF 30%, #90EE90 30%, #7CB342 100%);
            min-height: 400px;
            border-radius: 10px;
            position: relative;
            overflow: hidden;
            margin-bottom: 20px;
            padding: 40px 20px;
        }

        .finish-line {
            position: absolute;
            right: 30px;
            top: 0;
            bottom: 0;
            width: 20px;
            background: repeating-linear-gradient(
                45deg,
                #000,
                #000 10px,
                #fff 10px,
                #fff 20px
            );
            border: 3px solid #333;
        }

        .race-lane {
            position: relative;
            height: 120px;
            margin-bottom: 40px;
            border-bottom: 3px dashed #999;
        }

        .lane-label {
            position: absolute;
            left: 10px;
            top: 10px;
            font-weight: bold;
            font-size: 1.2em;
            padding: 5px 10px;
            border-radius: 5px;
            background: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .horse {
            position: absolute;
            left: 60px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 3em;
            transition: left 1.5s ease-out;
            filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.3));
        }

        .horse.blue {
            color: #4A90E2;
        }

        .horse.red {
            color: #E74C3C;
        }

        .runner {
            display: inline-block;
            transform: scaleX(-1);
            animation: running 0.5s ease-in-out infinite;
        }

        @keyframes running {
            0% { 
                transform: scaleX(-1) translateY(0px) rotate(0deg); 
            }
            25% { 
                transform: scaleX(-1) translateY(-5px) rotate(-3deg); 
            }
            50% { 
                transform: scaleX(-1) translateY(0px) rotate(0deg); 
            }
            75% { 
                transform: scaleX(-1) translateY(-5px) rotate(3deg); 
            }
            100% { 
                transform: scaleX(-1) translateY(0px) rotate(0deg); 
            }
        }

        .horse.blue .runner {
            animation-delay: 0s;
        }

        .horse.red .runner {
            animation-delay: 0.25s;
        }

        .horse.moving .runner {
            animation: running-fast 0.3s ease-in-out infinite;
        }

        @keyframes running-fast {
            0% { 
                transform: scaleX(-1) translateY(0px) rotate(0deg) scale(1); 
            }
            25% { 
                transform: scaleX(-1) translateY(-8px) rotate(-5deg) scale(1.05); 
            }
            50% { 
                transform: scaleX(-1) translateY(0px) rotate(0deg) scale(1); 
            }
            75% { 
                transform: scaleX(-1) translateY(-8px) rotate(5deg) scale(1.05); 
            }
            100% { 
                transform: scaleX(-1) translateY(0px) rotate(0deg) scale(1); 
            }
        }

        .distance-marker {
            position: absolute;
            left: 60px;
            bottom: 5px;
            font-size: 0.9em;
            font-weight: bold;
            color: #333;
            background: white;
            padding: 2px 8px;
            border-radius: 5px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }

        .progress-bars {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .progress-container {
            flex: 1;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
        }

        .progress-label {
            font-weight: bold;
            margin-bottom: 8px;
            font-size: 1.1em;
        }

        .progress-label.blue {
            color: #4A90E2;
        }

        .progress-label.red {
            color: #E74C3C;
        }

        .progress-bar {
            background: #ddd;
            height: 30px;
            border-radius: 15px;
            overflow: hidden;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            transition: width 1.5s ease-out;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 0.9em;
        }

        .progress-fill.blue {
            background: linear-gradient(90deg, #4A90E2 0%, #5DADE2 100%);
        }

        .progress-fill.red {
            background: linear-gradient(90deg, #E74C3C 0%, #EC7063 100%);
        }

        .race-button {
            text-align: center;
            margin-top: 20px;
        }

        .winner-screen {
            display: none;
            text-align: center;
        }

        .winner-screen h2 {
            font-size: 3em;
            color: #667eea;
            margin-bottom: 20px;
            animation: bounce 1s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }

        .trophy {
            font-size: 5em;
            margin: 20px 0;
        }

        .hidden {
            display: none;
        }

        .error-message {
            background: #f5576c;
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>‚öîÔ∏è Batalla Constitucional Online ‚öîÔ∏è</h1>
            <p>T√≠tulo Preliminar de la Constituci√≥n Espa√±ola</p>
        </div>

        <div class="content">
            <!-- Pantalla de lobby -->
            <div class="lobby-screen" id="lobbyScreen">
                <h2>üåê Modo Multijugador Online</h2>
                <p>
                    Juega con un amigo desde cualquier lugar.<br>
                    Uno crea la sala y el otro se une con el c√≥digo.
                </p>

                <div class="lobby-options">
                    <button class="btn" onclick="createGame()">Crear Sala</button>
                    <button class="btn btn-secondary" onclick="showJoinGame()">Unirse a Sala</button>
                </div>

                <div id="joinGameDiv" class="hidden">
                    <div class="input-group">
                        <input type="text" id="gameCodeInput" placeholder="C√≥digo de sala" maxlength="4">
                    </div>
                    <button class="btn" onclick="joinGame()">Entrar</button>
                </div>

                <div id="gameCreatedDiv" class="hidden">
                    <div class="game-code">
                        <h3>C√≥digo de tu sala:</h3>
                        <div class="code" id="gameCodeDisplay"></div>
                    </div>
                    <div class="waiting-message">
                        ‚è≥ Esperando a que se una el otro jugador...
                    </div>
                    <div class="players-status">
                        <div class="player-slot ready">
                            <span>‚úÖ</span>
                            <span>Jugador 1 (T√∫) - Listo</span>
                        </div>
                        <div class="player-slot" id="player2Status">
                            <span>‚è≥</span>
                            <span>Jugador 2 - Esperando...</span>
                        </div>
                    </div>
                </div>

                <div id="errorDiv" class="hidden">
                    <div class="error-message" id="errorMessage"></div>
                </div>
            </div>

            <!-- Pantalla de espera -->
            <div class="waiting-screen" id="waitingScreen" style="display: none; text-align: center;">
                <h2 style="color: #667eea; font-size: 2em; margin-bottom: 20px;">‚úÖ ¬°Has terminado!</h2>
                <div class="waiting-message" style="font-size: 1.3em; margin: 30px 0;">
                    ‚è≥ Esperando a que <span id="waitingForPlayer">el otro jugador</span> termine...
                </div>
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin: 20px 0;">
                    <h3 style="color: #333; margin-bottom: 15px;">Tu puntuaci√≥n:</h3>
                    <div style="font-size: 2.5em; color: #f5576c; font-weight: bold;">
                        <span id="myScore">0</span> metros
                    </div>
                </div>
            </div>

            <!-- Pantalla de bienvenida -->
            <div class="welcome-screen" id="welcomeScreen">
                <h2>üéÆ ¬°Bienvenidos a la Gran Carrera Constitucional!</h2>
                <p>
                    Prep√°rense para una emocionante carrera en 9 etapas:<br><br>
                    <strong>üìö Cada Etapa:</strong> Estudiar√°s uno de los 9 art√≠culos del T√≠tulo Preliminar.<br>
                    Ambos jugadores responder√°n 5 preguntas sobre ese art√≠culo.<br><br>
                    <strong>üèÉ La Carrera:</strong> Despu√©s de cada etapa, ver√°s c√≥mo avanzan los corredores:<br>
                    ‚Ä¢ <span style="color: #4A90E2;">Corredor Azul üèÉ</span> (Jugador 1)<br>
                    ‚Ä¢ <span style="color: #E74C3C;">Corredora Roja üèÉ‚Äç‚ôÄÔ∏è</span> (Jugador 2)<br><br>
                    <strong>üèÜ Reglas:</strong><br>
                    ‚Ä¢ Cada respuesta correcta = tu corredor avanza 20 metros<br>
                    ‚Ä¢ M√°ximo por etapa = 100 metros (5 aciertos)<br>
                    ‚Ä¢ <strong>¬°El primero en completar las 9 etapas GANA!</strong><br><br>
                    ¬°Que gane el mejor atleta constitucionalista! üèÉ‚Äç‚ôÄÔ∏èüí®
                </p>
                <button class="btn" onclick="startGame()">¬°Comenzar Batalla!</button>
            </div>

            <!-- Pantalla de art√≠culo -->
            <div class="article-screen" id="articleScreen">
                <div class="article-box" id="articleBox"></div>
                <div class="timer" id="articleTimer">Tiempo para leer: <span id="timeLeft">30</span>s</div>
            </div>

            <!-- Pantalla de preguntas -->
            <div class="quiz-screen" id="quizScreen">
                <div class="player-info">
                    <h3 id="currentPlayer">Jugador 1</h3>
                    <div class="fuel-bar">
                        <div class="fuel-fill" id="fuelFill" style="width: 0%">
                            <span id="fuelText">0 L</span>
                        </div>
                    </div>
                </div>

                <div class="question-box">
                    <h4 id="questionText">Pregunta...</h4>
                    <div class="options" id="optionsContainer"></div>
                </div>

                <div style="text-align: center;">
                    <button class="btn" id="nextBtn" style="display: none;" onclick="nextQuestion()">Siguiente</button>
                </div>
            </div>

            <!-- Pantalla de carrera -->
            <div class="battle-screen" id="battleScreen">
                <div class="race-info">
                    <h3 id="raceTitle">Etapa 1 de 9</h3>
                    <p style="margin: 5px 0; color: #2d3436;">¬°Los corredores avanzan seg√∫n tus aciertos!</p>
                </div>

                <div class="progress-bars">
                    <div class="progress-container">
                        <div class="progress-label blue">üèÉ Jugador 1 (Hombre)</div>
                        <div class="progress-bar">
                            <div class="progress-fill blue" id="progress1" style="width: 0%">
                                <span id="progressText1">0m / 900m</span>
                            </div>
                        </div>
                    </div>
                    <div class="progress-container">
                        <div class="progress-label red">üèÉ‚Äç‚ôÄÔ∏è Jugador 2 (Mujer)</div>
                        <div class="progress-bar">
                            <div class="progress-fill red" id="progress2" style="width: 0%">
                                <span id="progressText2">0m / 900m</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="racetrack" id="racetrack">
                    <div class="finish-line"></div>
                    
                    <div class="race-lane">
                        <div class="lane-label" style="background: #4A90E2; color: white;">Jugador 1</div>
                        <div class="horse blue" id="horse1"><span class="runner">üèÉ</span></div>
                        <div class="distance-marker" id="distance1">0m</div>
                    </div>

                    <div class="race-lane">
                        <div class="lane-label" style="background: #E74C3C; color: white;">Jugador 2</div>
                        <div class="horse red" id="horse2"><span class="runner">üèÉ‚Äç‚ôÄÔ∏è</span></div>
                        <div class="distance-marker" id="distance2">0m</div>
                    </div>
                </div>

                <div class="race-button">
                    <button class="btn" id="continueBtn" onclick="continueRace()">Continuar a Siguiente Etapa</button>
                </div>
            </div>

            <!-- Pantalla de ganador -->
            <div class="winner-screen" id="winnerScreen">
                <div class="trophy">üèÜ</div>
                <h2 id="winnerText">¬°Jugador 1 Gana!</h2>
                <p style="font-size: 1.2em; color: #666; margin: 20px 0;">
                    ¬°Domina la Constituci√≥n y el campo de batalla!
                </p>
                <button class="btn" onclick="location.reload()">Jugar de Nuevo</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <script>
        // Configuraci√≥n de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyJCSHKPGMpezHW3o5AxR5Wzupuz3aI",
            authDomain: "carrera-constitucional.firebaseapp.com",
            databaseURL: "https://carrera-constitucional-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "carrera-constitucional",
            storageBucket: "carrera-constitucional.firebasestorage.app",
            messagingSenderId: "627786732121",
            appId: "1:627786732121:web:9f1cc7c0b94887a9501b48"
        };

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Variables del juego
        let gameId = null;
        let playerNumber = null; // 1 o 2
        let currentArticle = null;
        let currentPlayer = 1;
        let currentQuestion = 0;
        let player1Fuel = 0;
        let player2Fuel = 0;
        let player1Position = 0;
        let player2Position = 0;
        let currentArticleIndex = 0;
        let usedArticles = [];
        let runningSound = null;
        let runningInterval = null;

        // Base de datos de art√≠culos y preguntas
        const articles = [
            {
                number: 1,
                title: "Art√≠culo 1",
                text: "1. Espa√±a se constituye en un Estado social y democr√°tico de Derecho, que propugna como valores superiores de su ordenamiento jur√≠dico la libertad, la justicia, la igualdad y el pluralismo pol√≠tico.\n\n2. La soberan√≠a nacional reside en el pueblo espa√±ol, del que emanan los poderes del Estado.\n\n3. La forma pol√≠tica del Estado espa√±ol es la Monarqu√≠a parlamentaria.",
                questions: [
                    {
                        q: "¬øCu√°l NO es un valor superior del ordenamiento jur√≠dico espa√±ol?",
                        options: ["La libertad", "La fraternidad", "La igualdad", "El pluralismo pol√≠tico"],
                        correct: 1
                    },
                    {
                        q: "¬øEn qui√©n reside la soberan√≠a nacional?",
                        options: ["En el Rey", "En el pueblo espa√±ol", "En las Cortes Generales", "En el Gobierno"],
                        correct: 1
                    },
                    {
                        q: "¬øCu√°l es la forma pol√≠tica del Estado espa√±ol?",
                        options: ["Rep√∫blica parlamentaria", "Monarqu√≠a absoluta", "Monarqu√≠a parlamentaria", "Rep√∫blica presidencialista"],
                        correct: 2
                    },
                    {
                        q: "Espa√±a se constituye en un Estado:",
                        options: ["Liberal y de Derecho", "Social y democr√°tico de Derecho", "Federal y democr√°tico", "Confesional de Derecho"],
                        correct: 1
                    },
                    {
                        q: "¬øDe d√≥nde emanan los poderes del Estado?",
                        options: ["De la Constituci√≥n", "Del pueblo espa√±ol", "Del Rey", "Del Parlamento"],
                        correct: 1
                    }
                ]
            },
            {
                number: 2,
                title: "Art√≠culo 2",
                text: "La Constituci√≥n se fundamenta en la indisoluble unidad de la Naci√≥n espa√±ola, patria com√∫n e indivisible de todos los espa√±oles, y reconoce y garantiza el derecho a la autonom√≠a de las nacionalidades y regiones que la integran y la solidaridad entre todas ellas.",
                questions: [
                    {
                        q: "¬øEn qu√© se fundamenta la Constituci√≥n espa√±ola?",
                        options: ["En la diversidad regional", "En la unidad de la Naci√≥n espa√±ola", "En el derecho foral", "En la monarqu√≠a"],
                        correct: 1
                    },
                    {
                        q: "¬øQu√© reconoce la Constituci√≥n respecto a las nacionalidades y regiones?",
                        options: ["Su independencia", "Su derecho a la autonom√≠a", "Su soberan√≠a", "Su separaci√≥n"],
                        correct: 1
                    },
                    {
                        q: "La Naci√≥n espa√±ola es descrita como:",
                        options: ["Divisible y plural", "Com√∫n e indivisible", "Federal y aut√≥noma", "Regional y diversa"],
                        correct: 1
                    },
                    {
                        q: "¬øQu√© principio se garantiza entre las nacionalidades y regiones?",
                        options: ["La competitividad", "La solidaridad", "La independencia", "La jerarqu√≠a"],
                        correct: 1
                    },
                    {
                        q: "¬øC√≥mo califica la Constituci√≥n a la unidad de la Naci√≥n espa√±ola?",
                        options: ["Reversible", "Indisoluble", "Temporal", "Condicional"],
                        correct: 1
                    }
                ]
            },
            {
                number: 3,
                title: "Art√≠culo 3",
                text: "1. El castellano es la lengua espa√±ola oficial del Estado. Todos los espa√±oles tienen el deber de conocerla y el derecho a usarla.\n\n2. Las dem√°s lenguas espa√±olas ser√°n tambi√©n oficiales en las respectivas Comunidades Aut√≥nomas de acuerdo con sus Estatutos.\n\n3. La riqueza de las distintas modalidades ling√º√≠sticas de Espa√±a es un patrimonio cultural que ser√° objeto de especial respeto y protecci√≥n.",
                questions: [
                    {
                        q: "¬øCu√°l es la lengua oficial del Estado espa√±ol?",
                        options: ["El espa√±ol", "El castellano", "El ib√©rico", "Todas las lenguas espa√±olas"],
                        correct: 1
                    },
                    {
                        q: "¬øQu√© tienen todos los espa√±oles respecto al castellano?",
                        options: ["Solo el derecho a usarlo", "El deber de conocerlo y el derecho a usarlo", "Solo el deber de conocerlo", "La opci√≥n de aprenderlo"],
                        correct: 1
                    },
                    {
                        q: "¬øD√≥nde pueden ser oficiales las dem√°s lenguas espa√±olas?",
                        options: ["En todo el territorio nacional", "En sus respectivas Comunidades Aut√≥nomas", "Solo en documentos locales", "No pueden ser oficiales"],
                        correct: 1
                    },
                    {
                        q: "¬øC√≥mo considera la Constituci√≥n las modalidades ling√º√≠sticas de Espa√±a?",
                        options: ["Un problema a resolver", "Un patrimonio cultural", "Una cuesti√≥n administrativa", "Un derecho individual"],
                        correct: 1
                    },
                    {
                        q: "¬øQu√© protecci√≥n reciben las lenguas espa√±olas seg√∫n el art√≠culo 3?",
                        options: ["Protecci√≥n b√°sica", "Especial respeto y protecci√≥n", "Protecci√≥n opcional", "No se menciona"],
                        correct: 1
                    }
                ]
            },
            {
                number: 4,
                title: "Art√≠culo 4",
                text: "1. La bandera de Espa√±a est√° formada por tres franjas horizontales, roja, amarilla y roja, siendo la amarilla de doble anchura que cada una de las rojas.\n\n2. Los Estatutos podr√°n reconocer banderas y ense√±as propias de las Comunidades Aut√≥nomas. Estas se utilizar√°n junto a la bandera de Espa√±a en sus edificios p√∫blicos y en sus actos oficiales.",
                questions: [
                    {
                        q: "¬øCu√°ntas franjas tiene la bandera de Espa√±a?",
                        options: ["Dos", "Tres", "Cuatro", "Cinco"],
                        correct: 1
                    },
                    {
                        q: "¬øQu√© franja de la bandera es de doble anchura?",
                        options: ["La roja superior", "La amarilla", "La roja inferior", "Todas son iguales"],
                        correct: 1
                    },
                    {
                        q: "¬øPueden las Comunidades Aut√≥nomas tener banderas propias?",
                        options: ["No, est√° prohibido", "S√≠, si lo reconocen sus Estatutos", "Solo en d√≠as festivos", "Solo en el interior de edificios"],
                        correct: 1
                    },
                    {
                        q: "¬øC√≥mo deben usarse las banderas auton√≥micas en actos oficiales?",
                        options: ["Solas", "Junto a la bandera de Espa√±a", "Solo en edificios privados", "No pueden usarse"],
                        correct: 1
                    },
                    {
                        q: "Los colores de la bandera espa√±ola son:",
                        options: ["Rojo y amarillo", "Rojo, amarillo y azul", "Rojo, amarillo y rojo", "Amarillo, verde y rojo"],
                        correct: 2
                    }
                ]
            },
            {
                number: 5,
                title: "Art√≠culo 5",
                text: "La capital del Estado es la villa de Madrid.",
                questions: [
                    {
                        q: "¬øCu√°l es la capital del Estado espa√±ol?",
                        options: ["Barcelona", "Madrid", "Sevilla", "Valencia"],
                        correct: 1
                    },
                    {
                        q: "¬øC√≥mo se refiere el art√≠culo a Madrid?",
                        options: ["La ciudad de Madrid", "La villa de Madrid", "El municipio de Madrid", "La provincia de Madrid"],
                        correct: 1
                    },
                    {
                        q: "¬øPuede cambiar la capital seg√∫n la Constituci√≥n?",
                        options: ["S√≠, mediante ley ordinaria", "Solo mediante reforma constitucional", "S√≠, por decreto", "No lo especifica"],
                        correct: 1
                    },
                    {
                        q: "¬øDesde cu√°ndo Madrid es capital de Espa√±a constitucionalmente?",
                        options: ["Desde 1492", "Desde 1978", "Desde 1931", "Desde 1812"],
                        correct: 1
                    },
                    {
                        q: "El art√≠culo 5 es:",
                        options: ["El m√°s largo del T√≠tulo Preliminar", "El m√°s corto del T√≠tulo Preliminar", "De longitud media", "No existe"],
                        correct: 1
                    }
                ]
            },
            {
                number: 6,
                title: "Art√≠culo 6",
                text: "Los partidos pol√≠ticos expresan el pluralismo pol√≠tico, concurren a la formaci√≥n y manifestaci√≥n de la voluntad popular y son instrumento fundamental para la participaci√≥n pol√≠tica. Su creaci√≥n y el ejercicio de su actividad son libres dentro del respeto a la Constituci√≥n y a la ley. Su estructura interna y funcionamiento deber√°n ser democr√°ticos.",
                questions: [
                    {
                        q: "¬øQu√© expresan los partidos pol√≠ticos?",
                        options: ["El pluralismo social", "El pluralismo pol√≠tico", "La unidad nacional", "La diversidad regional"],
                        correct: 1
                    },
                    {
                        q: "Los partidos pol√≠ticos son instrumento fundamental para:",
                        options: ["El gobierno", "La participaci√≥n pol√≠tica", "La administraci√≥n", "El poder judicial"],
                        correct: 1
                    },
                    {
                        q: "¬øEs libre la creaci√≥n de partidos pol√≠ticos?",
                        options: ["S√≠, sin restricciones", "S√≠, dentro del respeto a la Constituci√≥n y la ley", "No, requiere autorizaci√≥n", "Solo en determinadas circunstancias"],
                        correct: 1
                    },
                    {
                        q: "¬øC√≥mo debe ser el funcionamiento interno de los partidos?",
                        options: ["Jer√°rquico", "Democr√°tico", "Autocr√°tico", "No se especifica"],
                        correct: 1
                    },
                    {
                        q: "Los partidos concurren a:",
                        options: ["La formaci√≥n del gobierno", "La manifestaci√≥n de la voluntad popular", "Las elecciones municipales", "El control judicial"],
                        correct: 1
                    }
                ]
            },
            {
                number: 7,
                title: "Art√≠culo 7",
                text: "Los sindicatos de trabajadores y las asociaciones empresariales contribuyen a la defensa y promoci√≥n de los intereses econ√≥micos y sociales que les son propios. Su creaci√≥n y el ejercicio de su actividad son libres dentro del respeto a la Constituci√≥n y a la ley. Su estructura interna y funcionamiento deber√°n ser democr√°ticos.",
                questions: [
                    {
                        q: "¬øQu√© defienden los sindicatos de trabajadores?",
                        options: ["Intereses pol√≠ticos", "Intereses econ√≥micos y sociales", "Intereses culturales", "Intereses religiosos"],
                        correct: 1
                    },
                    {
                        q: "¬øEs libre la creaci√≥n de sindicatos?",
                        options: ["No", "S√≠, dentro del respeto a la Constituci√≥n y la ley", "Solo con autorizaci√≥n", "Solo en el sector p√∫blico"],
                        correct: 1
                    },
                    {
                        q: "Las asociaciones empresariales contribuyen a:",
                        options: ["La defensa de intereses pol√≠ticos", "La promoci√≥n de intereses econ√≥micos y sociales propios", "El control del gobierno", "La administraci√≥n p√∫blica"],
                        correct: 1
                    },
                    {
                        q: "¬øC√≥mo debe ser la estructura interna de sindicatos y asociaciones empresariales?",
                        options: ["Autocr√°tica", "Democr√°tica", "Jer√°rquica", "No se especifica"],
                        correct: 1
                    },
                    {
                        q: "Este art√≠culo trata sobre:",
                        options: ["Solo sindicatos", "Solo empresarios", "Sindicatos y asociaciones empresariales", "Partidos pol√≠ticos"],
                        correct: 2
                    }
                ]
            },
            {
                number: 8,
                title: "Art√≠culo 8",
                text: "1. Las Fuerzas Armadas, constituidas por el Ej√©rcito de Tierra, la Armada y el Ej√©rcito del Aire, tienen como misi√≥n garantizar la soberan√≠a e independencia de Espa√±a, defender su integridad territorial y el ordenamiento constitucional.\n\n2. Una ley org√°nica regular√° las bases de la organizaci√≥n militar conforme a los principios de la presente Constituci√≥n.",
                questions: [
                    {
                        q: "¬øCu√°ntos ej√©rcitos componen las Fuerzas Armadas seg√∫n el art√≠culo?",
                        options: ["Dos", "Tres", "Cuatro", "Cinco"],
                        correct: 1
                    },
                    {
                        q: "¬øCu√°l NO es una rama de las Fuerzas Armadas mencionada?",
                        options: ["Ej√©rcito de Tierra", "La Guardia Civil", "La Armada", "Ej√©rcito del Aire"],
                        correct: 1
                    },
                    {
                        q: "La misi√≥n de las Fuerzas Armadas incluye:",
                        options: ["Garantizar la soberan√≠a", "Controlar el gobierno", "Legislar", "Impartir justicia"],
                        correct: 0
                    },
                    {
                        q: "¬øQu√© tipo de ley regula las bases de la organizaci√≥n militar?",
                        options: ["Ley ordinaria", "Ley org√°nica", "Decreto-ley", "Real Decreto"],
                        correct: 1
                    },
                    {
                        q: "Las Fuerzas Armadas deben defender:",
                        options: ["Solo el territorio", "El ordenamiento constitucional", "Solo al gobierno", "Solo a la monarqu√≠a"],
                        correct: 1
                    }
                ]
            },
            {
                number: 9,
                title: "Art√≠culo 9",
                text: "1. Los ciudadanos y los poderes p√∫blicos est√°n sujetos a la Constituci√≥n y al resto del ordenamiento jur√≠dico.\n\n2. Corresponde a los poderes p√∫blicos promover las condiciones para que la libertad y la igualdad del individuo y de los grupos en que se integra sean reales y efectivas; remover los obst√°culos que impidan o dificulten su plenitud y facilitar la participaci√≥n de todos los ciudadanos en la vida pol√≠tica, econ√≥mica, cultural y social.\n\n3. La Constituci√≥n garantiza el principio de legalidad, la jerarqu√≠a normativa, la publicidad de las normas, la irretroactividad de las disposiciones sancionadoras no favorables o restrictivas de derechos individuales, la seguridad jur√≠dica, la responsabilidad y la interdicci√≥n de la arbitrariedad de los poderes p√∫blicos.",
                questions: [
                    {
                        q: "¬øQui√©nes est√°n sujetos a la Constituci√≥n?",
                        options: ["Solo los ciudadanos", "Solo los poderes p√∫blicos", "Ciudadanos y poderes p√∫blicos", "Solo el gobierno"],
                        correct: 2
                    },
                    {
                        q: "¬øQu√© deben promover los poderes p√∫blicos?",
                        options: ["La desigualdad", "Condiciones para libertad e igualdad reales", "Solo el crecimiento econ√≥mico", "La jerarqu√≠a social"],
                        correct: 1
                    },
                    {
                        q: "La Constituci√≥n garantiza el principio de:",
                        options: ["Oportunidad", "Legalidad", "Conveniencia", "Discrecionalidad"],
                        correct: 1
                    },
                    {
                        q: "¬øPueden las normas sancionadoras ser retroactivas si son favorables?",
                        options: ["No, nunca", "S√≠, si son favorables", "Solo con autorizaci√≥n judicial", "No lo especifica"],
                        correct: 1
                    },
                    {
                        q: "La Constituci√≥n proh√≠be:",
                        options: ["La participaci√≥n ciudadana", "La arbitrariedad de los poderes p√∫blicos", "La seguridad jur√≠dica", "La jerarqu√≠a normativa"],
                        correct: 1
                    }
                ]
            }
        ];

        // Funciones de Firebase para multijugador
        function generateGameCode() {
            return Math.floor(1000 + Math.random() * 9000).toString();
        }

        function createGame() {
            gameId = generateGameCode();
            playerNumber = 1;
            
            const gameRef = database.ref('games/' + gameId);
            gameRef.set({
                player1: true,
                player2: false,
                gameState: 'waiting',
                currentArticleIndex: 0,
                player1Fuel: 0,
                player2Fuel: 0,
                player1Position: 0,
                player2Position: 0,
                currentPlayer: 1,
                currentQuestion: 0
            });

            document.getElementById('lobbyScreen').querySelector('.lobby-options').style.display = 'none';
            document.getElementById('gameCreatedDiv').classList.remove('hidden');
            document.getElementById('gameCodeDisplay').textContent = gameId;

            // Escuchar cuando se una el jugador 2
            gameRef.on('value', (snapshot) => {
                const game = snapshot.val();
                if (game && game.player2) {
                    document.getElementById('player2Status').classList.add('ready');
                    document.getElementById('player2Status').innerHTML = '<span>‚úÖ</span><span>Jugador 2 - Listo</span>';
                    
                    setTimeout(() => {
                        showWelcomeScreen();
                    }, 1000);
                }

                // Sincronizar estado del juego
                if (game && game.gameState) {
                    syncGameState(game);
                }
            });
        }

        function showJoinGame() {
            document.getElementById('joinGameDiv').classList.remove('hidden');
        }

        function joinGame() {
            const code = document.getElementById('gameCodeInput').value.toUpperCase();
            
            if (code.length !== 4) {
                showError('El c√≥digo debe tener 4 d√≠gitos');
                return;
            }

            const gameRef = database.ref('games/' + code);
            gameRef.once('value').then((snapshot) => {
                const game = snapshot.val();
                
                if (!game) {
                    showError('Sala no encontrada');
                    return;
                }

                if (game.player2) {
                    showError('Esta sala ya est√° llena');
                    return;
                }

                gameId = code;
                playerNumber = 2;

                gameRef.update({
                    player2: true
                });

                showWelcomeScreen();

                // Escuchar cambios en el juego
                gameRef.on('value', (snapshot) => {
                    const game = snapshot.val();
                    if (game && game.gameState) {
                        syncGameState(game);
                    }
                });
            });
        }

        function showError(message) {
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorDiv').classList.remove('hidden');
            setTimeout(() => {
                document.getElementById('errorDiv').classList.add('hidden');
            }, 3000);
        }

        function showWelcomeScreen() {
            document.getElementById('lobbyScreen').style.display = 'none';
            document.getElementById('welcomeScreen').style.display = 'block';
        }

        function updateGameState(updates) {
            if (gameId) {
                database.ref('games/' + gameId).update(updates);
            }
        }

        function finishQuiz() {
            // Guardar mi puntuaci√≥n en Firebase
            const updates = {};
            updates[`player${playerNumber}Fuel`] = playerNumber === 1 ? player1Fuel : player2Fuel;
            updates[`player${playerNumber}Finished`] = true;
            
            updateGameState(updates);
            
            // Mostrar pantalla de espera
            document.getElementById('quizScreen').style.display = 'none';
            showWaitingScreen();
        }

        function showWaitingScreen() {
            const waitingScreen = document.getElementById('waitingScreen');
            const myFuel = playerNumber === 1 ? player1Fuel : player2Fuel;
            
            document.getElementById('myScore').textContent = myFuel;
            document.getElementById('waitingForPlayer').textContent = 
                playerNumber === 1 ? 'Jugador 2' : 'Jugador 1';
            
            waitingScreen.style.display = 'block';
        }

        function syncGameState(game) {
            // Sincronizar variables del juego
            player1Fuel = game.player1Fuel || 0;
            player2Fuel = game.player2Fuel || 0;
            player1Position = game.player1Position || 0;
            player2Position = game.player2Position || 0;

            // Si estamos esperando en el lobby y el juego empieza
            if (game.gameState === 'article' && document.getElementById('lobbyScreen').style.display !== 'none') {
                document.getElementById('lobbyScreen').style.display = 'none';
                document.getElementById('welcomeScreen').style.display = 'block';
            }

            // Sincronizar art√≠culo
            if (game.gameState === 'article' && game.currentArticleIndex !== undefined) {
                const articleIndex = game.currentArticleIndex;
                
                // Si es un nuevo art√≠culo
                if (!currentArticle || articles.indexOf(currentArticle) !== articleIndex) {
                    currentArticle = articles[articleIndex];
                    currentArticleIndex = articleIndex + 1;
                    
                    // Si estoy en la pantalla de bienvenida o batalla, mostrar art√≠culo
                    const currentlyVisible = 
                        document.getElementById('welcomeScreen').style.display === 'block' ||
                        document.getElementById('battleScreen').style.display === 'block';
                    
                    if (currentlyVisible) {
                        document.getElementById('welcomeScreen').style.display = 'none';
                        document.getElementById('battleScreen').style.display = 'none';
                        showArticle();
                    }
                }
            }

            // Ambos jugadores han terminado ‚Üí mostrar carrera
            if (game.player1Finished && game.player2Finished && game.gameState !== 'race') {
                // Actualizar puntuaciones finales
                player1Fuel = game.player1Fuel || 0;
                player2Fuel = game.player2Fuel || 0;
                
                // Solo el jugador 1 cambia el estado a carrera
                if (playerNumber === 1) {
                    setTimeout(() => {
                        updateGameState({ 
                            gameState: 'race',
                            player1Finished: false,
                            player2Finished: false
                        });
                    }, 500);
                }
            }

            // Mostrar carrera cuando el estado cambia
            if (game.gameState === 'race') {
                const isWaiting = document.getElementById('waitingScreen').style.display === 'block';
                const isQuiz = document.getElementById('quizScreen').style.display === 'block';
                const isBattle = document.getElementById('battleScreen').style.display === 'block';
                
                if ((isWaiting || isQuiz) && !isBattle) {
                    document.getElementById('waitingScreen').style.display = 'none';
                    document.getElementById('quizScreen').style.display = 'none';
                    startBattle();
                }
            }

            // Sincronizar posiciones para la carrera
            if (game.player1Position !== undefined) {
                player1Position = game.player1Position;
                player2Position = game.player2Position;
                
                // Actualizar visualmente si estamos en la pantalla de carrera
                if (document.getElementById('battleScreen').style.display === 'block') {
                    updateRaceVisuals();
                }
            }
        }

        function updateRaceVisuals() {
            const trackWidth = document.getElementById('racetrack').offsetWidth - 150;
            const totalDistance = 900;
            
            const position1Percent = (player1Position / totalDistance) * trackWidth;
            const position2Percent = (player2Position / totalDistance) * trackWidth;
            
            document.getElementById('horse1').style.left = (60 + position1Percent) + 'px';
            document.getElementById('horse2').style.left = (60 + position2Percent) + 'px';
            
            document.getElementById('distance1').textContent = player1Position + 'm';
            document.getElementById('distance2').textContent = player2Position + 'm';
            
            const progress1Percent = (player1Position / totalDistance) * 100;
            const progress2Percent = (player2Position / totalDistance) * 100;
            
            document.getElementById('progress1').style.width = progress1Percent + '%';
            document.getElementById('progressText1').textContent = player1Position + 'm / 900m';
            
            document.getElementById('progress2').style.width = progress2Percent + '%';
            document.getElementById('progressText2').textContent = player2Position + 'm / 900m';
        }

        // Funciones del juego original
        function startGame() {
            document.getElementById('welcomeScreen').style.display = 'none';
            
            // Solo el jugador 1 selecciona el art√≠culo
            if (playerNumber === 1) {
                selectNextArticle();
                updateGameState({ 
                    gameState: 'article',
                    currentArticleIndex: articles.indexOf(currentArticle),
                    articleStartTime: Date.now()
                });
            }
            // El jugador 2 espera a recibir el art√≠culo
        }

        function selectNextArticle() {
            let availableArticles = articles.filter((_, index) => !usedArticles.includes(index));
            
            if (availableArticles.length === 0) {
                usedArticles = [];
                availableArticles = articles;
            }
            
            const randomIndex = Math.floor(Math.random() * availableArticles.length);
            currentArticle = availableArticles[randomIndex];
            
            const originalIndex = articles.indexOf(currentArticle);
            usedArticles.push(originalIndex);
            currentArticleIndex++;
        }

        function showArticle() {
            const articleScreen = document.getElementById('articleScreen');
            const articleBox = document.getElementById('articleBox');
            
            articleBox.innerHTML = `
                <h3>${currentArticle.title}</h3>
                <p style="white-space: pre-line;">${currentArticle.text}</p>
            `;
            
            articleScreen.style.display = 'block';
            document.getElementById('readyBtn').style.display = 'none';
            
            // Timer autom√°tico de 30 segundos
            let timeLeft = 30;
            const timer = setInterval(() => {
                timeLeft--;
                document.getElementById('timeLeft').textContent = timeLeft;
                
                if (timeLeft === 0) {
                    clearInterval(timer);
                    // Pasar autom√°ticamente al quiz
                    startQuiz();
                }
            }, 1000);
        }

        function startQuiz() {
            document.getElementById('articleScreen').style.display = 'none';
            document.getElementById('quizScreen').style.display = 'block';
            currentQuestion = 0;
            showQuestion();
        }

        function showQuestion() {
            const question = currentArticle.questions[currentQuestion];
            document.getElementById('questionText').textContent = `Pregunta ${currentQuestion + 1}/5: ${question.q}`;
            
            // Mostrar "T√∫" en lugar de n√∫mero de jugador
            document.getElementById('currentPlayer').textContent = `T√∫ - Jugador ${playerNumber}`;
            
            const optionsContainer = document.getElementById('optionsContainer');
            optionsContainer.innerHTML = '';
            
            question.options.forEach((option, index) => {
                const div = document.createElement('div');
                div.className = 'option';
                div.textContent = option;
                div.onclick = () => selectAnswer(index);
                optionsContainer.appendChild(div);
            });
            
            document.getElementById('nextBtn').style.display = 'none';
            updateFuelDisplay();
        }

        function selectAnswer(selected) {
            const question = currentArticle.questions[currentQuestion];
            const options = document.querySelectorAll('.option');
            
            options.forEach(opt => opt.style.pointerEvents = 'none');
            
            let myFuel = playerNumber === 1 ? player1Fuel : player2Fuel;
            
            if (selected === question.correct) {
                options[selected].classList.add('correct');
                myFuel += 20;
            } else {
                options[selected].classList.add('incorrect');
                options[question.correct].classList.add('correct');
            }
            
            // Actualizar mi combustible
            if (playerNumber === 1) {
                player1Fuel = myFuel;
            } else {
                player2Fuel = myFuel;
            }
            
            updateFuelDisplay();
            document.getElementById('nextBtn').style.display = 'inline-block';
        }

        function updateFuelDisplay() {
            const fuel = playerNumber === 1 ? player1Fuel : player2Fuel;
            const percentage = Math.min(fuel, 100);
            document.getElementById('fuelFill').style.width = percentage + '%';
            document.getElementById('fuelText').textContent = fuel + ' L';
        }

        function nextQuestion() {
            currentQuestion++;
            
            if (currentQuestion < 5) {
                showQuestion();
            } else {
                // He terminado mis preguntas
                finishQuiz();
            }
        }

        function finishQuiz() {
            // Guardar mi puntuaci√≥n en Firebase
            const updates = {};
            updates[`player${playerNumber}Fuel`] = playerNumber === 1 ? player1Fuel : player2Fuel;
            updates[`player${playerNumber}Finished`] = true;
            
            updateGameState(updates);
            
            // Mostrar pantalla de espera
            document.getElementById('quizScreen').style.display = 'none';
            showWaitingScreen();
        }

        function startBattle() {
            document.getElementById('quizScreen').style.display = 'none';
            document.getElementById('battleScreen').style.display = 'block';
            
            playRaceMusic();
            
            document.getElementById('raceTitle').textContent = `Etapa ${currentArticleIndex} de 9`;
            
            updateRaceDisplay();
            
            setTimeout(() => {
                animateHorses();
            }, 500);
        }

        function playRaceMusic() {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            
            function createFootstep() {
                const bufferSize = audioContext.sampleRate * 0.1;
                const buffer = audioContext.createBuffer(1, bufferSize, audioContext.sampleRate);
                const data = buffer.getChannelData(0);
                
                for (let i = 0; i < bufferSize; i++) {
                    const envelope = Math.exp(-i / (bufferSize * 0.3));
                    data[i] = (Math.random() * 2 - 1) * envelope * 0.3;
                }
                
                const source = audioContext.createBufferSource();
                source.buffer = buffer;
                
                const filter = audioContext.createBiquadFilter();
                filter.type = 'lowpass';
                filter.frequency.value = 800;
                filter.Q.value = 1;
                
                const bassOsc = audioContext.createOscillator();
                const bassGain = audioContext.createGain();
                bassOsc.frequency.value = 60;
                bassOsc.type = 'sine';
                
                bassGain.gain.setValueAtTime(0.2, audioContext.currentTime);
                bassGain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
                
                source.connect(filter);
                bassOsc.connect(bassGain);
                filter.connect(audioContext.destination);
                bassGain.connect(audioContext.destination);
                
                const now = audioContext.currentTime;
                source.start(now);
                source.stop(now + 0.1);
                bassOsc.start(now);
                bassOsc.stop(now + 0.1);
            }
            
            let stepCount = 0;
            runningInterval = setInterval(() => {
                createFootstep();
                stepCount++;
                
                if (stepCount > 20) {
                    stopRunningSound();
                }
            }, 250);
            
            runningSound = audioContext;
        }
        
        function stopRunningSound() {
            if (runningInterval) {
                clearInterval(runningInterval);
                runningInterval = null;
            }
        }

        function animateHorses() {
            const trackWidth = document.getElementById('racetrack').offsetWidth - 150;
            const totalDistance = 900;
            
            document.getElementById('horse1').classList.add('moving');
            document.getElementById('horse2').classList.add('moving');
            
            const position1Percent = (player1Position / totalDistance) * trackWidth;
            const position2Percent = (player2Position / totalDistance) * trackWidth;
            
            document.getElementById('horse1').style.left = (60 + position1Percent) + 'px';
            document.getElementById('horse2').style.left = (60 + position2Percent) + 'px';
            
            document.getElementById('distance1').textContent = player1Position + 'm';
            document.getElementById('distance2').textContent = player2Position + 'm';
            
            const progress1Percent = (player1Position / totalDistance) * 100;
            const progress2Percent = (player2Position / totalDistance) * 100;
            
            document.getElementById('progress1').style.width = progress1Percent + '%';
            document.getElementById('progressText1').textContent = player1Position + 'm / 900m';
            
            document.getElementById('progress2').style.width = progress2Percent + '%';
            document.getElementById('progressText2').textContent = player2Position + 'm / 900m';
            
            setTimeout(() => {
                document.getElementById('horse1').classList.remove('moving');
                document.getElementById('horse2').classList.remove('moving');
                stopRunningSound();
            }, 1500);
            
            if (player1Position >= totalDistance || player2Position >= totalDistance) {
                setTimeout(() => {
                    showWinner();
                }, 2000);
                document.getElementById('continueBtn').style.display = 'none';
            }
        }

        function updateRaceDisplay() {
            const advancePlayer1 = player1Fuel;
            const advancePlayer2 = player2Fuel;
            
            player1Position += advancePlayer1;
            player2Position += advancePlayer2;
            
            player1Fuel = 0;
            player2Fuel = 0;
            
            if (playerNumber === 1) {
                updateGameState({
                    player1Position: player1Position,
                    player2Position: player2Position,
                    player1Fuel: 0,
                    player2Fuel: 0
                });
            }
        }

        function continueRace() {
            if (currentArticleIndex >= 9) {
                showWinner();
                return;
            }
            
            currentQuestion = 0;
            
            document.getElementById('battleScreen').style.display = 'none';
            
            // Solo el jugador 1 selecciona el siguiente art√≠culo
            if (playerNumber === 1) {
                selectNextArticle();
                updateGameState({
                    gameState: 'article',
                    currentArticleIndex: articles.indexOf(currentArticle),
                    player1Finished: false,
                    player2Finished: false,
                    player1Fuel: 0,
                    player2Fuel: 0
                });
            }
            
            // Resetear combustible local
            player1Fuel = 0;
            player2Fuel = 0;
        }

        function showWinner() {
            document.getElementById('battleScreen').style.display = 'none';
            const winnerScreen = document.getElementById('winnerScreen');
            
            let winner;
            if (player1Position > player2Position) {
                winner = 1;
                document.getElementById('winnerText').textContent = 'üèÉ ¬°El Corredor Azul Gana! üèÜ';
            } else if (player2Position > player1Position) {
                winner = 2;
                document.getElementById('winnerText').textContent = 'üèÉ‚Äç‚ôÄÔ∏è ¬°La Corredora Roja Gana! üèÜ';
            } else {
                document.getElementById('winnerText').textContent = 'üèÉ‚Äç‚ôÄÔ∏èüèÉ ¬°Empate Hist√≥rico! üèÜ';
            }
            
            winnerScreen.style.display = 'block';
        }
    </script>
</body>
</html>
