<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Juego de Lectura</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Georgia', 'Times New Roman', serif;
            background-color: white;
            color: #666;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            transition: background-color 0.3s, color 0.3s;
            font-size: 16px;
        }

        body.large-text {
            font-size: 20px;
        }

        body.large-text .pregunta {
            font-size: 26px;
        }

        body.large-text .respuesta {
            font-size: 20px;
        }

        body.large-text button {
            font-size: 22px;
        }

        body.large-text textarea {
            font-size: 20px;
        }

        body.large-text .mensaje-temporal {
            font-size: 24px;
        }

        body.dark-mode {
            background-color: #1a1a1a;
            color: #999;
        }

        body.dark-mode button {
            background: #1a1a1a;
            color: #999;
        }

        body.dark-mode textarea {
            background: #1a1a1a;
            color: #999;
        }

        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }

        .font-toggle {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1000;
        }

        .sound-toggle {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 1000;
        }

        .transcript-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }

        .theme-button {
            width: 30px;
            height: 30px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 24px;
            color: #666;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            line-height: 1;
            transition: opacity 0.3s;
        }

        .theme-button:hover {
            opacity: 0.6;
        }

        body.dark-mode .theme-button {
            color: #999;
        }

        .font-button {
            width: 30px;
            height: 30px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 24px;
            color: #666;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            line-height: 1;
            transition: opacity 0.3s;
        }

        .font-button:hover {
            opacity: 0.6;
        }

        body.dark-mode .font-button {
            color: #999;
        }

        .sound-button {
            width: 30px;
            height: 30px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 24px;
            color: #666;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            line-height: 1;
            transition: opacity 0.3s;
        }

        .sound-button:hover {
            opacity: 0.6;
        }

        body.dark-mode .sound-button {
            color: #999;
        }

        .transcript-button {
            width: 30px;
            height: 30px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 24px;
            color: #666;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            line-height: 1;
            transition: opacity 0.3s;
        }

        .transcript-button:hover {
            opacity: 0.6;
        }

        body.dark-mode .transcript-button {
            color: #999;
        }

        .container {
            max-width: 600px;
            width: 100%;
            text-align: left;
        }

        .centered {
            text-align: center;
        }

        button {
            background: white;
            border: none;
            color: #666;
            font-size: 18px;
            cursor: pointer;
            padding: 10px 20px;
            font-family: inherit;
            transition: opacity 0.3s;
        }

        button:hover {
            opacity: 0.6;
        }

        .fade-in {
            animation: fadeIn 1s ease-in;
        }

        .fade-out {
            animation: fadeOut 0.5s ease-out forwards;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }

        .container {
            position: relative;
            min-height: 200px;
        }

        .pregunta {
            font-weight: bold;
            margin-bottom: 15px;
            font-size: 20px;
        }

        .respuesta {
            margin-bottom: 30px;
            line-height: 1.6;
            font-size: 16px;
        }

        textarea {
            width: 100%;
            min-height: 150px;
            background: white;
            border: none;
            color: #666;
            font-family: inherit;
            font-size: 16px;
            resize: vertical;
            outline: none;
            line-height: 1.6;
            margin-bottom: 20px;
        }

        body.dark-mode textarea {
            background: #1a1a1a;
            color: #999;
        }

        .voice-button-circular {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            background: white;
            border: 2px solid #666;
            color: #666;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 30px;
            transition: opacity 0.3s, transform 0.2s, background-color 0.3s;
            font-family: inherit;
        }

        body.dark-mode .voice-button-circular {
            background: #1a1a1a;
            border-color: #999;
            color: #999;
        }

        .voice-button-circular:hover {
            opacity: 0.8;
            transform: scale(1.05);
        }

        .voice-button-circular.recording {
            background-color: #ff4444;
            color: white;
            border-color: #ff4444;
            animation: pulse 1.5s infinite;
        }

        body.dark-mode .voice-button-circular.recording {
            background-color: #ff4444;
            color: white;
            border-color: #ff4444;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .palabra-clave {
            background-color: #ffeb3b;
            padding: 2px 4px;
            border-radius: 3px;
            animation: palpitar 2s ease-in-out infinite;
            font-weight: bold;
        }

        body.dark-mode .palabra-clave {
            background-color: #ffc107;
            color: #1a1a1a;
        }

        @keyframes palpitar {
            0%, 100% { 
                transform: scale(1);
                opacity: 1;
            }
            50% { 
                transform: scale(1.05);
                opacity: 0.8;
            }
        }

        .voice-status {
            font-size: 18px;
            margin-bottom: 20px;
            text-align: center;
            min-height: 30px;
        }

        .mensaje-temporal {
            font-size: 20px;
            text-align: center;
        }

        .hidden {
            display: none;
        }

        .transcripcion-texto {
            min-height: 100px;
            margin-bottom: 30px;
            padding: 20px;
            background-color: #f5f5f5;
            border-radius: 8px;
            line-height: 1.6;
            text-align: left;
        }

        body.dark-mode .transcripcion-texto {
            background-color: #2a2a2a;
        }

        @media (max-width: 768px) {
            body {
                padding: 15px;
            }

            .pregunta {
                font-size: 18px;
            }

            .respuesta {
                font-size: 15px;
            }

            button {
                font-size: 16px;
            }

            .voice-button-circular {
                width: 160px;
                height: 160px;
                font-size: 20px;
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 10px;
            }

            .pregunta {
                font-size: 16px;
            }

            .respuesta {
                font-size: 14px;
            }

            button {
                font-size: 15px;
            }

            .voice-button-circular {
                width: 140px;
                height: 140px;
                font-size: 18px;
            }
        }
    </style>
</head>
<body>
    <div class="font-toggle">
        <button class="font-button" id="fontToggle">+</button>
    </div>

    <div class="theme-toggle">
        <button class="theme-button" id="themeToggle">o</button>
    </div>

    <div class="sound-toggle">
        <button class="sound-button" id="soundToggle">)))</button>
    </div>

    <div class="transcript-toggle hidden">
        <button class="transcript-button" id="transcriptToggle">*</button>
    </div>
    
    <div class="container" id="app">
        <div class="centered">
            <button id="btnInicio" class="fade-in">¡Comencémos!</button>
        </div>
    </div>

    <script>
        // Datos de preguntas de ejemplo
        const preguntas = [
    {
        pregunta: "¿Qué es JavaScript?",
        respuesta: "JavaScript es un lenguaje de programación que se utiliza principalmente en la web para crear interacción. Con JavaScript se puede trabajar con HTML y hacer que una página web sea dinámica.",
        palabrasclave: "JavaScript, lenguaje de programación, web, interacción, HTML"
    },
    {
        pregunta: "¿Qué es una variable en JavaScript?",
        respuesta: "Una variable en JavaScript es un valor que se puede guardar y cambiar. En JavaScript, una variable se declara usando let, var o const.",
        palabrasclave: "variable, JavaScript, valor, let, var, const"
    },
    {
        pregunta: "¿Qué es una función en JavaScript?",
        respuesta: "Una función en JavaScript es un bloque de código que permite reutilizar código. Las funciones en JavaScript se ejecutan cuando son llamadas.",
        palabrasclave: "función, JavaScript, bloque de código, reutilizar código, llamadas"
    }
];


        let indicePreguntaActual = 0;
        let faseActual = 1;
        let soundEnabled = true;
        let transcriptVisible = false;
        const app = document.getElementById('app');

        // Sound toggle
        const soundToggle = document.getElementById('soundToggle');
        const savedSound = localStorage.getItem('soundEnabled');
        
        if (savedSound === 'false') {
            soundEnabled = false;
            soundToggle.textContent = '×';
        } else {
            soundToggle.textContent = ')))';
        }

        soundToggle.addEventListener('click', () => {
            soundEnabled = !soundEnabled;
            soundToggle.textContent = soundEnabled ? ')))' : '×';
            localStorage.setItem('soundEnabled', soundEnabled);
            
            // Detener cualquier lectura en curso
            if (!soundEnabled && window.speechSynthesis) {
                window.speechSynthesis.cancel();
            }
        });

        // Theme toggle
        const themeToggle = document.getElementById('themeToggle');
        const savedTheme = localStorage.getItem('theme');
        
        if (savedTheme === 'dark') {
            document.body.classList.add('dark-mode');
        }

        themeToggle.addEventListener('click', () => {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
        });

        // Font size toggle
        const fontToggle = document.getElementById('fontToggle');
        const savedFontSize = localStorage.getItem('fontSize');
        
        if (savedFontSize === 'large') {
            document.body.classList.add('large-text');
            fontToggle.textContent = '−';
        }

        fontToggle.addEventListener('click', () => {
            document.body.classList.toggle('large-text');
            const isLarge = document.body.classList.contains('large-text');
            fontToggle.textContent = isLarge ? '−' : '+';
            localStorage.setItem('fontSize', isLarge ? 'large' : 'normal');
        });

        // Transcript toggle
        const transcriptToggleDiv = document.querySelector('.transcript-toggle');
        const transcriptToggle = document.getElementById('transcriptToggle');

        transcriptToggle.addEventListener('click', () => {
            transcriptVisible = !transcriptVisible;
            transcriptToggle.textContent = transcriptVisible ? 'º' : '*';
            
            const transcripcionTexto = document.getElementById('transcripcionTexto');
            if (transcripcionTexto) {
                transcripcionTexto.classList.toggle('hidden');
            }
        });

        function normalizar(texto) {
            return texto
                .toLowerCase()
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '')
                .replace(/[^a-z0-9\s]/g, ' ')
                .trim();
        }

        function obtenerRaiz(palabra) {
            palabra = palabra.toLowerCase();
            const sufijos = ['s', 'es', 'a', 'as', 'o', 'os'];
            for (let sufijo of sufijos) {
                if (palabra.endsWith(sufijo) && palabra.length > sufijo.length + 2) {
                    return palabra.slice(0, -sufijo.length);
                }
            }
            return palabra;
        }

        function verificarPalabrasClave(textoUsuario, palabrasClave) {
            const textoNormalizado = normalizar(textoUsuario);
            const palabras = textoNormalizado.split(/\s+/);
            const raicesTexto = palabras.map(p => obtenerRaiz(p));
            
            const claves = palabrasClave.split(',').map(p => normalizar(p.trim()));
            const faltantes = [];
            
            for (let clave of claves) {
                const raizClave = obtenerRaiz(clave);
                const encontrada = raicesTexto.some(raiz => 
                    raiz.includes(raizClave) || raizClave.includes(raiz)
                );
                if (!encontrada) {
                    faltantes.push(clave);
                }
            }
            
            return faltantes;
        }

        function resaltarPalabrasClave(texto, palabrasClave) {
            const claves = palabrasClave.split(',').map(p => p.trim());
            let textoResaltado = texto;
            
            // Ordenar por longitud descendente para evitar reemplazos parciales
            claves.sort((a, b) => b.length - a.length);
            
            for (let clave of claves) {
                // Crear expresión regular que sea insensible a mayúsculas y acentos
                const regex = new RegExp(`\\b${clave.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}\\b`, 'gi');
                textoResaltado = textoResaltado.replace(regex, match => `<span class="palabra-clave">${match}</span>`);
            }
            
            return textoResaltado;
        }

        function mostrarMensajeTemporal(mensaje, callback, duracionExtra = false) {
            app.innerHTML = `<div class="centered mensaje-temporal fade-in">${mensaje}</div>`;
            const duracion = duracionExtra ? 4000 : 2000;
            setTimeout(() => {
                const elemento = app.querySelector('.mensaje-temporal');
                elemento.classList.remove('fade-in');
                elemento.classList.add('fade-out');
                setTimeout(callback, 500);
            }, duracion);
        }

        function mostrarTexto(fase) {
            // Ocultar el botón de transcripción cuando no estamos en la pantalla de voz
            transcriptToggleDiv.classList.add('hidden');
            
            const preguntaActual = preguntas[indicePreguntaActual];
            let mensaje = '';
            let duracionExtra = false;
            
            if (fase === 1) {
                mensaje = 'Lee atentamente';
            } else if (fase === 2) {
                mensaje = '¿Hay alguna palabra que no entiendes? Ahora vuelve a leerlo con un diccionario o similar junto a ti buscando esas palabras';
                duracionExtra = true;
            } else if (fase === 3) {
                mensaje = 'Por último, léelo una última vez intentando memorizarlo';
            }
            
            mostrarMensajeTemporal(mensaje, () => {
                // Si es la fase 3, resaltar palabras clave
                let respuestaHTML = preguntaActual.respuesta;
                if (fase === 3) {
                    respuestaHTML = resaltarPalabrasClave(preguntaActual.respuesta, preguntaActual.palabrasclave);
                }
                
                app.innerHTML = `
                    <div class="fade-in">
                        <div class="pregunta">${preguntaActual.pregunta}</div>
                        <div class="respuesta">${respuestaHTML}</div>
                        <div class="centered">
                            <button id="btnTerminado">YA HE TERMINADO</button>
                        </div>
                    </div>
                `;
                
                // Leer la pregunta y respuesta si el sonido está activado
                if (soundEnabled && window.speechSynthesis) {
                    const textoCompleto = preguntaActual.pregunta + '. ' + preguntaActual.respuesta;
                    const utterance = new SpeechSynthesisUtterance(textoCompleto);
                    utterance.lang = 'es-ES';
                    utterance.rate = 0.9;
                    window.speechSynthesis.speak(utterance);
                }
                
                document.getElementById('btnTerminado').addEventListener('click', () => {
                    // Detener la lectura al pasar a la siguiente fase
                    if (window.speechSynthesis) {
                        window.speechSynthesis.cancel();
                    }
                    
                    if (fase < 3) {
                        mostrarTexto(fase + 1);
                    } else {
                        mostrarCampoEscritura();
                    }
                });
            }, duracionExtra);
        }

        function mostrarCampoEscritura() {
            mostrarMensajeTemporal('A continuación habla lo que recuerdas', () => {
                // Mostrar el botón de transcripción
                transcriptToggleDiv.classList.remove('hidden');
                transcriptVisible = false;
                transcriptToggle.textContent = '*';
                
                app.innerHTML = `
                    <div class="fade-in">
                        <div class="voice-status" id="voiceStatus"></div>
                        <div class="centered">
                            <button class="voice-button-circular" id="voiceButton">ESCUCHAR</button>
                        </div>
                        <div class="transcripcion-texto hidden" id="transcripcionTexto"></div>
                        <div class="centered">
                            <button id="btnTerminado">YA HE TERMINADO</button>
                        </div>
                    </div>
                `;
                
                const btnTerminado = document.getElementById('btnTerminado');
                btnTerminado.addEventListener('click', verificarRespuesta);
                
                iniciarReconocimientoVoz(btnTerminado);
            });
        }

        function iniciarReconocimientoVoz(btnTerminado) {
            const voiceButton = document.getElementById('voiceButton');
            const transcripcionTexto = document.getElementById('transcripcionTexto');
            const voiceStatus = document.getElementById('voiceStatus');

            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                voiceButton.style.display = 'none';
                voiceStatus.textContent = 'Reconocimiento de voz no disponible';
                return;
            }

            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            let recognition = null;
            
            let isRecording = false;
            let allTranscript = ''; // Acumulador de todo el texto de todas las sesiones

            voiceButton.addEventListener('click', () => {
                if (!isRecording) {
                    // Iniciar grabación
                    recognition = new SpeechRecognition();
                    recognition.lang = 'es-ES';
                    recognition.continuous = true;
                    recognition.interimResults = true;
                    recognition.maxAlternatives = 1;

                    let sessionTranscript = ''; // Texto de esta sesión específica

                    recognition.onresult = (event) => {
                        let interimTranscript = '';

                        for (let i = event.resultIndex; i < event.results.length; i++) {
                            const transcript = event.results[i][0].transcript;
                            if (event.results[i].isFinal) {
                                sessionTranscript += (sessionTranscript ? ' ' : '') + transcript;
                            } else {
                                interimTranscript = transcript;
                            }
                        }

                        // Mostrar todo el texto acumulado + texto de esta sesión
                        transcripcionTexto.textContent = allTranscript + (allTranscript && sessionTranscript ? ' ' : '') + sessionTranscript + (interimTranscript ? ' ' + interimTranscript : '');
                    };

                    recognition.onerror = (event) => {
                        console.error('Error de reconocimiento:', event.error);
                        if (event.error !== 'no-speech' && event.error !== 'aborted') {
                            voiceStatus.textContent = 'Error: ' + event.error;
                        }
                    };

                    recognition.onend = () => {
                        // Al terminar, guardar el texto de esta sesión en el acumulador
                        if (sessionTranscript) {
                            allTranscript += (allTranscript ? ' ' : '') + sessionTranscript;
                            transcripcionTexto.textContent = allTranscript;
                        }
                        
                        // Cambiar el estado visual
                        isRecording = false;
                        voiceButton.classList.remove('recording');
                        voiceButton.textContent = 'ESCUCHAR';
                        voiceStatus.textContent = 'Pausa - Pulsa el botón para continuar';
                    };

                    try {
                        recognition.start();
                        isRecording = true;
                        voiceButton.classList.add('recording');
                        voiceButton.textContent = 'ESCUCHANDO';
                        voiceStatus.textContent = 'Hablando...';
                    } catch (e) {
                        console.error('Error al iniciar:', e);
                    }
                } else {
                    // Detener grabación manualmente
                    if (recognition) {
                        try {
                            recognition.stop();
                        } catch (e) {
                            console.error('Error al detener:', e);
                        }
                    }
                    isRecording = false;
                    voiceButton.classList.remove('recording');
                    voiceButton.textContent = 'ESCUCHAR';
                    voiceStatus.textContent = '';
                }
            });

            // Detener el reconocimiento y limpiar cuando se presiona "YA HE TERMINADO"
            btnTerminado.addEventListener('click', () => {
                if (recognition && isRecording) {
                    try {
                        recognition.stop();
                    } catch (e) {
                        console.error('Error al detener:', e);
                    }
                    isRecording = false;
                    voiceButton.classList.remove('recording');
                    voiceButton.textContent = 'ESCUCHAR';
                    voiceStatus.textContent = '';
                }
                // Resetear el acumulador para la siguiente pregunta
                allTranscript = '';
            }, { once: false });
        }

        function verificarRespuesta() {
            const textoUsuario = document.getElementById('transcripcionTexto').textContent.trim();
            
            // Ocultar el botón de transcripción
            transcriptToggleDiv.classList.add('hidden');
            
            if (textoUsuario === '') {
                mostrarMensajeTemporal('Debes hablar algo antes de continuar', () => {
                    mostrarCampoEscritura();
                });
                return;
            }
            
            const preguntaActual = preguntas[indicePreguntaActual];
            const faltantes = verificarPalabrasClave(textoUsuario, preguntaActual.palabrasclave);
            
            if (faltantes.length === 0) {
                mostrarMensajeTemporal('MUY BIEN, PASAMOS A LA SIGUIENTE PREGUNTA', () => {
                    indicePreguntaActual++;
                    if (indicePreguntaActual < preguntas.length) {
                        mostrarTexto(1);
                    } else {
                        app.innerHTML = '<div class="centered fade-in"><button id="btnFinalizar" style="font-size: 24px;">YA TE SABES LA LECCIÓN</button></div>';
                        document.getElementById('btnFinalizar').addEventListener('click', () => {
                            window.close();
                        });
                    }
                });
            } else {
                const palabrasFaltantes = faltantes.join(', ');
                app.innerHTML = `
                    <div class="centered fade-in">
                        <div style="margin-bottom: 30px;">Te han faltado estas palabras clave: ${palabrasFaltantes}</div>
                        <button id="btnRepasar">VOLVER A REPASAR</button>
                    </div>
                `;
                document.getElementById('btnRepasar').addEventListener('click', () => {
                    mostrarTexto(1);
                });
            }
        }

        document.getElementById('btnInicio').addEventListener('click', () => {
            mostrarTexto(1);
        });
    </script>
</body>
</html>