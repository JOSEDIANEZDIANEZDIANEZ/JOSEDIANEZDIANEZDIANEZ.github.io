<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<title>Juego</title>
<style>
  :root {
    --bg: #f6f7fb;
    --card: #fff;
  }

  html, body {
    height: 100%;
    margin: 0;
    padding: 0;
    font-family: Arial, sans-serif;
    background: var(--bg);
    color: #111;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  #main-container {
    width: 90%;
    max-width: 900px;
    display: flex;
    flex-direction: column;
    align-items: flex-start;
  }

  #startBtn {
    width: 25vw;
    max-width: 150px;
    aspect-ratio: 1;
    border-radius: 50%;
    background: var(--card);
    border: 4px solid #222;
    font-size: 4vw;
    max-font-size: 22px;
    cursor: pointer;
    margin: 20px 0;
    align-self: center;
  }

  #titulo {
    font-size: 6vw;
    max-font-size: 32px;
    margin-bottom: 10px;
  }

  #pregunta {
    font-weight: 700;
    font-size: 4vw;
    max-font-size: 28px;
    margin-top: 10px;
    padding-right: 5%;
    text-align: left;          
  }

  #contenedor {
    font-size: 4vw;
    max-font-size: 28px;
    line-height: 1.5;
    width: 100%;
    word-wrap: break-word;
    margin-top: 20px;
    text-align: left;          
    max-height: 60vh;
    overflow-y: auto;
    padding-right: 5px;
  }

  .blur {
    filter: blur(6px);
    color: transparent;
    text-shadow: 0 0 8px rgba(0,0,0,0.35);
  }

  .wrong {
    text-decoration: underline red;
    color: inherit;
    filter: none;
  }

  .word {
    white-space: pre-wrap;
  }

  @media(max-width: 400px) {
    #titulo { font-size: 8vw; }
    #pregunta, #contenedor { font-size: 5vw; }
    #startBtn { width: 30vw; font-size: 5vw; }
  }
</style>
</head>
<body>

<div id="main-container">
  <button id="startBtn" aria-label="Empezar juego">Empezar</button>
  <h1 id="titulo"></h1>
  <div id="pregunta"></div>
  <div id="contenedor" aria-live="polite"></div>
</div>

<script>
// Carga del archivo preguntas.js
const script = document.createElement('script');
script.src = 'preguntas.js';
document.head.appendChild(script);

let indice = 0;
let synthesis = window.speechSynthesis;
let recognition = null;
let palabrasBorrosas = [];
let currentIndex = 0;

script.onload = () => {
    document.getElementById('titulo').textContent = titulo_del_juego || "JUEGO";
};

// ----------------------------------------
// Funciones JavaScript principales
// ----------------------------------------

function normalizar(str){
    if(!str) return '';
    return str.normalize("NFD")
             .replace(/[\u0300-\u036f]/g,'')
             .toLowerCase()
             .replace(/[^a-z0-9ñ]/g,'');
}

function prepararTexto(preg){
    const texto = preg.respuesta;
    const claves = preg.palabrasclave.split(',').map(c => normalizar(c));

    const tokens = texto.match(/\S+|\s+/g) || [];

    palabrasBorrosas = tokens.map(tok => {
        const bare = tok.trim();
        if(bare.length === 0)
            return { text: tok, blurred:false, isWord:false };

        return {
            text: tok,
            blurred: claves.includes(normalizar(bare)),
            isWord: true
        };
    });
}

function mostrarTexto(){
    const cont = document.getElementById('contenedor');
    cont.innerHTML = "";

    palabrasBorrosas.forEach((obj,i)=>{
        const span = document.createElement('span');
        span.id = "w"+i;
        span.className = "word";
        span.textContent = obj.text;
        if(obj.blurred) span.classList.add('blur');
        cont.appendChild(span);
    });
}

function speakText(text, onend){
    if(!synthesis){ onend && onend(); return; }

    const u = new SpeechSynthesisUtterance(text);
    u.lang = "es-ES";
    u.rate = 1.0;
    u.onend = onend;
    synthesis.cancel();
    synthesis.speak(u);
}

// ----------------------------------------
// Reconocimiento de voz
// ----------------------------------------

function startRecognition(onResult, onError){
    if(recognition){ try{ recognition.abort(); }catch(e){} }

    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if(!SR){
        onError && onError("no-sr");
        return;
    }

    recognition = new SR();
    recognition.lang = 'es-ES';
    recognition.interimResults = false;
    recognition.maxAlternatives = 1;

    let responded = false;
    let silenceTimer = null;

    silenceTimer = setTimeout(()=>{ 
        if(!responded){
            responded = true;
            try{ recognition.stop(); }catch(e){}
            onError && onError("silencio");
        }
    }, 4000);

    recognition.onresult = e => {
        if(responded) return;
        responded = true;
        clearTimeout(silenceTimer);

        const texto = (e.results[0][0].transcript || "").trim();
        onResult && onResult(texto);
    };

    recognition.onerror = e => {
        if(responded) return;
        responded = true;
        clearTimeout(silenceTimer);
        onError && onError(e);
    };

    recognition.onend = () => {
        if(!responded){
            responded = true;
            clearTimeout(silenceTimer);
            onError && onError("no-sonido");
        }
    };

    try{
        recognition.start();
    }catch(e){
        clearTimeout(silenceTimer);
        onError && onError(e);
    }
}

// ----------------------------------------
// Manejo de respuestas y lectura
// ----------------------------------------

function manejarRespuestaUsuario(i, dicho){
    const span = document.getElementById("w"+i);

    // Scroll automático a la palabra actual
    if(span) span.scrollIntoView({ behavior: 'smooth', block: 'center' });

    const correcto = normalizar(palabrasBorrosas[i].text);
    const dichoNorm = normalizar(dicho);

    try{ recognition && recognition.stop(); }catch(e){}

    // Regex para aceptar la palabra repetida varias veces
    const regex = new RegExp(`^(?:${correcto}\\s*)+$`);

    if(regex.test(dichoNorm)){
        palabrasBorrosas[i].blurred = false;
        span.classList.remove('blur','wrong');
    } else {
        palabrasBorrosas[i].blurred = false;
        span.classList.remove('blur');
        span.classList.add('wrong');
    }

    speakText(palabrasBorrosas[i].text, ()=>{
        currentIndex++;
        leerSiguiente();
    });
}

function leerSiguiente(){
    if(currentIndex >= palabrasBorrosas.length){
        cargarSiguiente();
        return;
    }

    const obj = palabrasBorrosas[currentIndex];

    if(obj.isWord){
        const span = document.getElementById("w"+currentIndex);
        if(span) span.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    if(obj.isWord && obj.blurred){
        startRecognition(
            texto => manejarRespuestaUsuario(currentIndex, texto),
            ()     => manejarRespuestaUsuario(currentIndex, "")
        );
        return;
    }

    let textoParaLeer = "";

    while(currentIndex < palabrasBorrosas.length){
        const t = palabrasBorrosas[currentIndex];

        if(t.isWord && t.blurred) break;

        textoParaLeer += t.text;
        currentIndex++;
    }

    speakText(textoParaLeer, ()=>{
        leerSiguiente();
    });
}

function cargarPregunta(){
    const p = preguntas[indice];
    document.getElementById('pregunta').textContent = p.pregunta;

    prepararTexto(p);
    mostrarTexto();

    currentIndex = 0;
    leerSiguiente();
}

function cargarSiguiente(){
    indice++;
    if(indice >= preguntas.length) indice = 0;
    cargarPregunta();
}

document.getElementById("startBtn").onclick = ()=>{
    document.getElementById("startBtn").style.display = "none";
    cargarPregunta();
};
</script>
</body>
</html>
